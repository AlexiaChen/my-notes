世界计算机以一种不直观的方式体验时间：每12秒提出一个新的区块，代表EVM内1000次的瞬时变化。

这就是在这12秒的其余时间里发生的事情。

以太坊是世界计算机，一个全球共享的计算平台，存在于由1000多台计算机组成的网络之间，每台计算机都运行一个本地版本的以太坊虚拟机（EVM）。

该网络能够通过一个共识系统保持同步。

在它的头7年里，以太坊使用工作证明（PoW）来达成共识并保持同步；今天它使用股权证明（PoS）。

这两种方法都是以确定一个节点为前提，该节点获得向区块链添加新区块的特权（记账权）。

在PoW下，节点（矿工）通过竞争来获得成为下一个区块提议者(block proposer)的权利。提议者（the proposer）是一个强大的地位；他们不仅可以按照自己的意愿挑选和排序txns，而且还可以赚取。

- 区块奖励(block reward)，由区块链网络支付(相当于增发)
- 小费(Tips)，由txn的生成者支付

比赛：一个难以置信的难题，只能通过追踪和错误来解决。矿工们猜啊猜，直到解开谜题，证明他们在现实世界中做过工作（用电为解决这些谜题的机器供电）。

在PoW下，区块提议者(block proposer)是能够最快解决加密难题的矿工。完成后，它将其区块广播给网络中的每个其他节点。

然后，每个节点都会检查，以确保txns是有效的，谜题是完整的。

PoS从根本上说是不同的--根本不存在竞争（竞争出块）。

与其通过浪费尽可能多的电力来选择下一个区块的提议者，如果我们只是......轮流做呢？

这就是PoS的核心；32个ETH代币股份（抵押）只是保证良好行为的保证金。

从PoW到PoS的一个影响是，我们已经转换了PoW的基本节奏。

 这个基本节奏是基于一个从不可预测的比赛中得出的时间单位转换到基于回合制的系统。

就其本质而言，我们无法控制PoW的时间，但我们可以控制PoS的时间。

 今天，世界计算机上的时间被划分为12秒单位，称为 "slots"。

每个时段，都有一个不同的validator节点被分配来提出（propose）一个新的区块。如果它履行了自己的职责，它将提出一个有效的区块（在4秒内），否则这个slot将空着。

区块提议者将把区块发送给网络中的每个节点，然后由这些节点负责处理区块并更新其EVM的状态。

这使所有节点与提议者保持同步，并将各自EVM的环境变成集体的世界计算机。

每个slot也有一个分配给它的委员会(committee)。委员会是一组validators(a group of validators)，他们被分配来校验和证明(attest)区块提议者（block proposer）所广播的区块的有效性。

在验证之后，委员会成员（committee members）广播一个加密的证明(attestation)。

 此刻，有44万名validators。如果每个validator都在每个委员会(committee)中，那么网络会在大量的证明（attestations）下冻结。

所以我们做了一个去中心化的权衡。每个validator不会对每个slot进行验证，但他们会对每个epoch进行验证(attest)。

> 相当于committee是验证slots的，而每个validator是验证epoch的

一个epoch是由32个slots组成的。1个slot=12秒，所以1个epoch=6分24秒

在每个slot的开始，整个验证器组（validator group）被随机分成32个委员会（committees），对应于即将到来的纪元（upcoming epoch）的32个slots。

这种随机性是不简单的；我们需要RANDAO

[[ETH之随机性和RANDAO]]

每个slot都会有一个新的委员会上前。第一个成员是区块提议者；其余的是出席验证者(attesters)。（这里相当于block proposer是在新的委员会成员中选择出来的，委员会的成员位置要被随机排序）

区块提议者有4秒钟的时间向它在的这个委员会发送一个区块。每个委员会成员验证该区块并创建一个BLS签名（如果没有区块，他们就证明(attest)最后一个区块）。

BLS签名是一种数字签名，它提供了所有正常的保证（证明一个特定的信息是由一个特定的人签署的），但有一个有用的额外属性：它可以被聚合。

一旦聚集起来，成千上万的签名可以在一次操作中得到验证。

详情请看 [[BLS数字签名]]


 对于那些不在家里的人来说，44万个validators/32个委员会=13.7k个validators/委员会。这个数字太大，无法一下子被聚合。（每个委员会有13.7k个validator节点）

因此，委员会(committees)被分解成128个子网(subnets)。

~100个validators/子网 （每个subnet大约100个validators）

 在每个子网中，16个validators被指定为聚合者。所有的子网成员都会发布他们的BLS签名，但只有聚合者会聆听并进行聚合。

所有16个成员都试图建立相同的理想聚合签名，但条件往往不理想。

接下来，区块提议者将从128个子网中各挑选一个最佳的BLS聚合签名（也就是128个聚合签名）。

BLS聚合算法最后一次被应用，128个子网的聚合签名被聚合成一个最终的委员会BLS签名，代表~13.7k个validators

作为一个旁观者，这整个过程是32个ETH代币抵押是成为validator所需的最低金额的原因。这个聚合过程是缓慢而复杂的；减少最低赌注金额会增加validator的数量，使问题呈指数级增长。（validator的准入门槛不能太低）。

32个slots之后，一个epoch结束。

在每个epoch结束时，每个validator都运行`process_epoch`。下面的推文会给你更详细的信息，但我们将把它总结为2个部分。

- 最终确定(Finalization)
-  共识（consensus）和内务(Housekeeping)

详情请看 [[ETH之共识规范#^49a5f2]]

最终确定性是Casper FFG协议的应用。[[ETH之Casper FFG共识]]

简单来说，最终确定性是协议的一个承诺，即一个epoch（以及其中的区块/交易）是不可逆转的。（一个epoch是32个区块）

最终确定性是数学和经济上的保证，即世界计算机上的一个具体行动是典型区块链(canonical blockchain)的一部分。

撤销一个已完成的交易将需要销毁1/3的押注的ETH代币--这1/3的ETH代币价值在今天超过200亿美元。

纪元（epochs）标志着最终确定性的边界。

如果在一个epoch中超过2/3的网络证明(attest)，它就成为合理的。

如果在第一个epoch之后，第二个epoch有2/3的多数(majority)，它将最终确定该epoch，这给予以太坊的安全保障。

`process_epoch`的另一部分是共识和内务管理。

基本上，这是维护共识规则（处理slashing、奖励等）和为下一个epoch重置舞台所需的一切。

总结：

- slot：每12秒，世界计算机期待一个新的区块（EVM变化）。
- epoch：每32个slots，是整个网络投票
- 最终确定性(Finalization)：在第一个epoch决定后，第二个epoch中的超级多数的validators投票确认当前epoch

最终确定性=ETH代币的安全