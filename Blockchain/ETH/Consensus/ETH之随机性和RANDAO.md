随机性是密码学和以太坊世界计算机的关键属性。不幸的是，计算机在没有外部输入的情况下生成随机性是很糟糕的......而EVM没有外部输入。

这是一份在不受信任的环境下的随机性指南。

![[Pasted image 20221009110939.png]]

 随机性是一种不可预测的特性，是一种无法预见下一步会发生什么的能力。

它不是一种二元的品质；有些事情可能比其他事情更随机。天气似乎是随机的，但我们可以（试图）预测它；彩票是（希望）完全随机的。

一般来说，计算机应该以预期的方式执行。同样的输入应该产生同样的输出，每次都是如此。

一台将随机性引入执行的计算机实际上是无法使用的。

然而，显然有一些重要的应用依赖于可信的随机性（例如，生成以太坊的私钥）。

那么，这种随机性从何而来？计算机（通常）依赖于合理的不可预测的外部输入的概念。

例如，一台正常的计算机可能使用其用户的鼠标动作作为生成随机数的基础。鼠标的移动是非常具体的；两个人在足够长的时间内以同样的方式移动他们的鼠标--无论是否有意，都是非常不可能的。

以太坊是世界计算机，一个全球共享的计算平台，存在于1000多台电脑的网络之间，每台电脑都运行着本地版本的以太坊虚拟机（EVM）。

无论是否幸运，EVM都是与外界隔绝的。

解决这个问题的方法之一是使用oracles，这是一种在世界计算机和互联网之间架起信息桥梁的服务类型。

然而，oracles并不属于以太坊依靠一个oracle有外部信任的假设，而且可能非常耗费gas（昂贵）。

与之相反的是，以太坊依靠一个RANDAO机制来创建协议级的随机性。

RANDAO是一个由信标链(beacon chain)维护的值；在每个区块中，提议者(the proposer，区块提议者)将自己的随机贡献混合到现有的RANDAO值中。

想象一下，你有一副你想随机洗牌的牌。实现可信的随机性的一种方法是将这副牌在桌子上传来传去，每个人轮流洗牌。

即使有一个人试图作弊，累积起来的结果仍然是非常随机的。

![[Pasted image 20221009112011.png]]

对于 以太坊，链上保持着一个RANDAO值。当一个区块提议者(block proposer)创建一个新的区块时，它会加入它的贡献。你可以在区块中看到贡献(`randao_reveal`) 这个字段可以在 [[ETH的PoS区块]] 中看到

每个贡献需要满足2个属性：它应该是不可预测的，但又是可验证的。

RANDAO贡献的早期想法是让每个validator创建一个 "哈希洋葱(hash onion)"，一个通过重复哈希随机数建立的数据结构。然而，这种方法很笨重，在一些边缘情况下开始崩溃。

取而代之的是，以太坊使用了一种不同的方法。

当以太坊改变了它的数字签名方案时，那一个自然的代替方案就出现了，这个方案就是围绕着BLS
签名构建的。

简而言之就是，BLS签名始于用于生成私钥的外部随机性。这些密钥被用来签署信息，然后聚合到一起。[[BLS数字签名]]

在数据层面上，一个聚合的BLS密钥与一个单一的BLS密钥是相同的；它们共享相同的大小，使用相同的验证算法。

这个属性对于共识过程是极其重要的，但是作为RANDAO的功能，它特别有用。

有了BLS签名，每个validator都已经有了一个严密保护的随机数--他们的私钥--实现了不可预测性。

此外，每个节点都可以通过验证BLS签名来验证RANDAO的贡献 - 实现可验证性。

具体来说，RANDAO的贡献是其正常的BLS签名，以epoch编号（认为是区块号）作为信息。

这个贡献既被印在区块中（`randao_reveal`），也被混入EVM的RANDAO值中。

在RANDAO计划中，混合是结合贡献的过程；在我们的卡片比喻中，混合就是洗牌。

对于ethereum中，我们首先对BLS签名进行Hash，然后用一个叫做xor的操作将其与之前的RANDAO值混合。

![[Pasted image 20221009113053.png]]

![[Pasted image 20221009113131.png]]

每次创建一个新的区块，RANDAO都会被更新，只是多了一点随机性。因此，通过每个提议验证者(proposing validator，block proposer)的无信任贡献，我们产生了一个足够的随机值。

这个值现在可以提供给 以太坊的共识和EVM。

实际上，如果一个dApp依赖于真正的随机性，他们可能会使用一个可验证的随机函数（VRF），形成一个像chainlink这样的oracle。

RANDAO的真正目的是为共识提供随机性。

一个完全可预测的协议是非常脆弱的。攻击者可以

- 对提案人(block proposer)或委员会进行DDoS攻击，以试图停止该链。
- 贿赂一个即将到来的提案人(block proposer)
- 试图注册有利的validator编号，试图获得对一个委员会的控制权
- 等等

以太坊的RANDAO并不完美，但它非常强大。要深入了解RANDAO的一些问题，请查看这个 [Upgrading Ethereum | 2.9.2 Randomness (eth2book.info)](https://eth2book.info/altair/part2/building_blocks/randomness#randao-biasability) 

但对我们来说，RANDAO已经足够好了。只要想想 "RANDAO对于权益证明来说是足够随机的"。