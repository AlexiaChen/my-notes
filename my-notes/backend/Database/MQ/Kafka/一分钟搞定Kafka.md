
这是一个分布式的提交日志。

日志是最简单的数据结构 - 一系列有序记录，只支持追加操作。

它是不可变的，所以无法删除或编辑记录。

![[Pasted image 20240115141800.png]]

Kafka将其数据存储在主题(Topic)中。

它们被分割成分区(partition)，并在代理(broker)之间进行复制。

大致结构如下：主题→分区→副本(replica)→一堆文件（日志）

1. 每个主题有多个分区

2. 每个分区有多个（3个）副本

3. 每个副本有一堆文件

所有的文件都是日志。

Kafka是一个分布式系统，每台服务器称为一个代理(broker)。

代理托管了各自的分区副本。

![[Pasted image 20240115142029.png]]

还剩下什么？

客户端。数据是如何进出Kafka的？

很简单。

1. 客户端（生产者）将消息（记录）发送到Kafka节点（代理）。

他们只能写入分区的领导者(leader)。

2. 其他被称为消费者的客户端读取并处理这些消息。

消费者可以从任何分区中读取，无论是领导者(leader)还是追随者(follower)。

![[Pasted image 20240115142200.png]]

这些通过TCP连接到代理，并使用自定义协议（Kafka协议）与代理进行通信。

生产者/消费者客户端只是一个实现了Kafka协议并提供良好接口以便与之交互的Java库。

如今，几乎每种语言都有对应的实现。

最后呢？

Kafka是一个分布式系统。它需要协调(coordination)。

Kafka通过具有特定角色的代理（称为“控制器(controller)”）来实现此目标。

在任何时刻，只会有一个活动控制器存在。

控制器是集群中元数据的主要来源和真相源泉。

它负责许多事情，其中之一就是通过临时更改分区领导权来处理代理故障问题。

• 常规代理之间的领导选举由控制器完成。
• 控制器之间（选择活动控制器）的领导选举则采用Raft变体（KRaft）完成

整个集群的元数据存储在一个简单但特殊的Kafka主题中，其领导者即为活动控制器所在位置。

所有代理都复制该主题 - 这就是它们获取元数据信息的方式。

![[Pasted image 20240115142420.png]]