
## 相关概念和术语

### 什么是Apache CloudStack

Apache CloudStack是一个开源的基础设施即服务（IaaS）平台，用于管理和编排存储、网络和计算资源池，以构建公共或私有的IaaS计算云。

使用CloudStack您可以：

- 设置按需弹性云计算服务。
- 允许最终用户配置资源。

### Apache CloudStack可以做什么

#### 多Hypervisor支持

CloudStack与各种类型的虚拟化技术和类似虚拟化技术兼容。单个云中可以包含多个不同的虚拟化实现。截至当前版本，CloudStack支持以下虚拟化平台：

- 裸金属， BareMetal（通过IPMI）
- Hyper-V
- KVM
- LXC
- vSphere（通过vCenter）
- Xenserver
- Xen Project

#### 大规模可扩展基础设施管理

CloudStack可以管理分布在地理位置不同的数据中心中安装的数万台物理服务器。管理服务器具有近线性扩展能力，无需集群级别的管理服务器。即使管理服务器发生维护或其他故障，也不会影响云中运行的实例。

#### 自动化的云配置管理

CloudStack自动配置每个实例部署的网络和存储设置。在内部，一组虚拟设备支持云本身的配置操作。这些设备提供防火墙、路由、DHCP、VPN、控制台代理、存储访问和存储复制等服务。广泛使用可横向扩展的实例简化了云的安装和运行操作。

#### 图形用户界面

CloudStack提供了一个管理员的Web界面，用于云的配置和管理，以及一个终端用户的Web界面，用于运行实例和管理实例模板。用户界面可以根据所需的服务提供商或企业外观进行定制。

#### API

CloudStack为云的操作、管理和使用提供了类似REST的API。

#### AWS EC2 API支持

CloudStack提供了一个EC2 API翻译层，允许常见的EC2工具在使用CloudStack云时使用。

#### 高可用

CloudStack具有多项功能，以提高系统的可用性。管理服务器本身可以部署在多节点安装中，其中服务器进行负载均衡。MySQL可以配置使用复制来在数据库丢失时提供故障转移。对于主机，CloudStack支持NIC绑定和使用独立网络进行存储以及iSCSI多路径。

### 部署架构概览

一般来说，大多数CloudStack部署包括管理服务器和要进行管理的资源。在部署过程中，您需要向管理服务器提供要进行管理的资源信息，例如IP地址块、存储设备、虚拟化软件和VLAN。

最小安装需一个运行CloudStack管理服务器的机器以及另一台作为云基础架构的机器（在这种情况下，是一个非常简单的基础架构，只有一台运行虚拟化软件的主机）。在最小部署中，一台单独的机器可以同时充当管理服务器和虚拟化主机（使用KVM虚拟化技术）。

![[Pasted image 20240218154622.png]]

一个更全功能的安装包括一个高可用的多节点管理服务器安装和使用几种网络技术之一的数以万计的主机。

#### 管理服务器概览

管理服务器在您的云部署中协调和分配资源。

管理服务器通常运行在专用机器或虚拟机上。它控制将实例分配给主机，并为实例分配存储和IP地址。管理服务器在Apache Tomcat容器中运行，并需要一个MySQL数据库进行持久化。

管理服务器：

- 为管理员和终端用户提供Web界面。
- 为CloudStack API和EC2接口提供API接口。
- 管理将客户实例分配给特定计算资源
- 管理公共和私有IP地址的分配。
- 在VM实例化过程中分配存储空间。
- 管理快照、磁盘镜像（模板）和ISO镜像。
- 为您的云提供单一配置点。

#### 云基础设施概览

云中的资源管理如下：

- 区域(Regions)：由一个或多个地理上相邻的区域组成，由一个或多个管理服务器进行管理。
- 可用区域(Zones)：通常，一个区域等同于一个数据中心。一个区域包括一个或多个机柜和二级存储。
- 机柜(Pods)：通常是一台机架，或者是一排机架，包括一台二层交换机和一个或多个集群。
- 集群(Clusters)：由一个或多个同质主机和主存储组成。
- 主机(Host)：集群内的单个计算节点；通常是虚拟化程序。
- 主存储(Primary storage)：用于实际运行实例磁盘映像的单个集群提供的存储资源。（尽管不常使用，但也可以选择在整个Zone范围内提供主存储。）
- 次要存储(Secondary storage)：整个Zone范围内用于存储磁盘模板、ISO镜像和快照的资源。

#### 网络概览

CloudStack提供多种类型的网络，但通常可以归为以下两种情况：

- 基本：最类似于AWS经典风格的网络。提供一个单一的大二层网络，在此网络中，通过虚拟化管理程序桥接设备在三层上实现客户隔离。
- 高级：通常使用诸如VLAN之类的二层隔离技术，但该类别还包括Nicira NVP等SDN技术。
### CloudStack术语

#### Regions

为了增加云的可靠性，您可以选择将资源分组到多个地理区域中。一个Region区域是CloudStack部署中最大的可用组织单位。一个区域由几个可用区(AZ,Available Zone)组成，每个可用区大致相当于一个数据中心。每个区域由其自己的管理服务器集群控制，在其中一个可用区运行。一个Region区域中的各个可用区通常位于地理上紧密相邻的位置。使用Region区域技术可以提供容错和灾难恢复功能。

通过将可用区分组到不同的Region地理区域，云可以实现更高的可用性和扩展性。用户账户可以跨越多个Region地理区域，这样用户就能在多个广泛分散的地方部署实例。即使其中一个Region地理 区 域能够使用 ，服务仍然对最终用户 可以通过在另一 个 Region地 理 区 布置 的 实 例 中 使用 。并且通过将具有共同附近管理服务器 的 可 用 区 组合 在一起 ，与从单一集中式管理服务器管理广泛分散 的 可 用 区 相比 ，云内部通信延迟得到了缩短。

还可以在整体级别上汇总和跟踪使用记录，并为每个Region地理 区 域 创建报告或发票。

![[Pasted image 20240218160118.png]]

Region区域对终端用户可见。当用户在特定的CloudStack管理服务器上启动一个访客实例时，用户隐式地选择了该Region区域作为其访客实例所在的区域。用户可能还需要将他们的私有模板复制到其他Region区域，以便在这些Region区域中使用自己的模板创建访客实例。

#### Zones

一个Zone区域是CloudStack部署中第二大的组织单位。通常情况下，一个Zone区域对应一个数据中心，尽管在一个数据中心内可以有多个Zone区域。将基础设施组织成Zone区域的好处是提供物理隔离和冗余。例如，每个Zone区域可以拥有自己的电源供应和网络上行，并且这些Zone区域可以在地理上广泛分开（尽管这不是必需的）。

一个Zone区域包括：

- 一个或多个Pods。每个Pod包含一个或多个主机集群以及一台或多台主存储服务器。
- 一个Zone区域能够包含一台或多台主存储服务器，这些服务器由该Zone区域内所有的Pod共享。
- 次要存储，由该Zone区域内所有的Pod共享。

![[Pasted image 20240218160613.png]]

Zone区域对终端用户可见。当用户启动一个访客实例时，用户必须为其访客选择一个区域。用户可能还需要将他们的私有模板复制到其他区域，以便在这些区域中使用他们的模板创建访客实例。

Zone区域可以是公共或私有的。公共Zone区域对所有用户可见。这意味着任何用户都可以在该Zone区域创建一个访客。私有Zone区域专门为特定领域保留。只有该领域或其子领域能够在该Zone区域内创建访客。

同一Zone区域中的主机彼此直接可达，无需经过防火墙。不同Zone区域能够通过静态配置的 VPN 隧道相互访问。

对于每个Zone区域，管理员必须决定以下事项：

- 每个Zone区要放置多少个 Pod。
- 每个 Pod 要放置多少个集群。
- 每个集群要放置多少台主机。
- （可选）每个Zone要放置多少台主存储服务器和这些存储服务器的总容量。
- 每个集群要放置多少台主存储服务器和这些存储服务器的总容量。
- 部署在某一Zone区域上的次要存储容量是多少。

当您使用CloudStack UI添加新Zone时，将提示您配置该Zone区域的物理网络，并添加第一个pod、cluster、host、primary storage和secondary storage。

为了支持VMware的Zone级功能，CloudStack意识到VMware数据中心，并可以将每个数据中心映射到一个CloudStack Zone区域。为了启用存储实时迁移和VMware主机的 Zone区域级主存储等功能，CloudStack必须确保一个Zone区域仅包含单个VMware数据中心。因此，在创建新的CloudStack Zone区域时，您可以为该Zone区域选择一个VMware数据中心。如果您正在提供多个VMware数据中心，则每个数据中心都将在CloudStack中设置为单独的Zone区域。

> 如果您正在从以前的CloudStack版本升级，并且您现有的部署包含来自多个VMware数据中心的集群的Zone区域，该Zone区域将不会被强制迁移到新模型。它将继续像以前一样运行。然而，在该Zone区域中将无法使用任何新的Zone区域范围操作，例如Zone区域范围内主存储和实时存储迁移。

#### Pods

一个Pod通常代表一个机架(rack)。同一Pod中的主机位于相同的子网中。在CloudStack部署中，Pod是第三大组织单位。Pods包含在Zone区域内。每个Zone区域可以包含一个或多个Pods。一个Pod由一个或多个主机集群和一个或多个主存储服务器组成。对终端用户来说，Pods是不可见的。

![[Pasted image 20240218161414.png]]
#### Clusters

一个集群提供了一种将主机分组的方式。准确地说，一个集群是XenServer服务器池、一组KVM服务器或预先在vCenter中配置的VMware集群。集群中的主机具有相同的硬件，运行相同的虚拟化程序，位于同一个子网，并访问相同的共享主存储。实例可以在同一个集群内从一个主机迁移到另一个主机，而不会中断用户服务。

在CloudStack部署中，集群是第四大组织单位。集群包含在Pods中，而Pods则包含在区域（Zones）中。尽管CloudStack建议大多数情况下限制集群大小较小；请参阅最佳实践。

一个集群由一个或多个主机和一个或多个主存储服务器组成。

![[Pasted image 20240218161641.png]]

CloudStack允许在云部署中使用多个集群。

即使仅使用本地存储，组织上仍然需要集群，即使每个集群只有一个主机。

当使用VMware时，每个VMware集群都由vCenter服务器管理。管理员必须将vCenter服务器注册到CloudStack中。每个Zone区域可能有多个vCenter服务器。每个vCenter服务器可以管理多个VMware集群。
#### Hosts

主机是一台单独的计算机。主机提供运行客户实例所需的计算资源。每个主机上都安装了虚拟化软件来管理客户实例。例如，一个主机可以是Citrix XenServer服务器、Linux KVM启用的服务器、ESXi服务器或Windows Hyper-V服务器。

在CloudStack部署中，主机是最小的组织单位。主机包含在集群内，集群包含在Pod内，Pod包含在Zone区域内，而Zone区域可以包含在地理位置不同的多个数据中心内。

CloudStack部署中的主机：

- 提供托管实例所需的CPU、内存、存储和网络资源
- 使用高带宽TCP/IP网络进行互联，并连接到互联网
- 可能位于不同地理位置上的多个数据中心
- 可能具有不同容量（不同CPU速度、不同RAM数量等），尽管集群内的所有主机必须是相同类型

可以随时添加其他主机以提供更多的客户实例容量。

CloudStack会自动检测主机提供的CPU和内存资源数量。

对于终端用户来说，主机是不可见的。终端用户无法确定他们的客户所分配到哪个主机上。

要使主机在CloudStack中正常工作，您必须执行以下操作：

- 在主机上安装虚拟化软件
- 为主机分配一个IP地址
- 确保该主机与CloudStack管理服务器连接

#### 主存储-Primary Storage

主存储与集群相关联，用于存储在该集群中的主机上运行的所有实例的虚拟磁盘。在KVM和VMware上，您可以按Zone区域为主存储进行配置。

您可以将多个主存储服务器添加到一个集群或Zone区域中。至少需要一个。它通常靠近主机以提高性能。CloudStack管理将客户虚拟磁盘分配给特定的主存储设备。

当您想要避免额外的数据复制操作时，设置Zone区域范围内的主存储非常有用。使用基于集群的主存储时，只有该集群内部的实例才能直接访问主存储中的数据。如果不同集群中的实例需要一些数据，则必须通过使用Zone区域次要存储作为中间步骤从一个集群复制到另一个集群。这个操作可能会浪费时间。

对于Hyper-V，支持SMB/CIFS 存储。请注意，在Hyper-V 中不支持Zone区域范围内的 主 存 儲 。

Ceph/RBD 存 儲 只 支 持 KVM 虛 擬 化 程 序 。 它可 以 用 作 Zone区域 的 主 存 儲 。
 
PowerFlex/ScaleIO (v3.5) 只支持 KVM 虛擬化程序。它可以用作集群范围或Zone区域范围的主存储。

CloudStack被设计为与所有符合标准的iSCSI和NFS服务器配合使用，这些服务器由底层虚拟化平台支持，包括但不限于：

- SolidFire用于iSCSI
- Dell EqualLogic™用于iSCSI
- Network Appliances filers用于NFS和iSCSI
- Scale Computing用于NFS
- Dell EMC PowerFlex™（v3.5）
- HPE Primera/3PAR用于FiberChannel
- Pure FlashArray用于FiberChannel

如果您只打算使用本地磁盘进行安装，则可以跳过添加单独的主存储。

#### 次要存储-Secondary Storage

次要存储包括以下内容：

- 模板(Templates) — 可用于启动实例的操作系统镜像，可以包含额外的配置信息，如已安装的应用程序
- ISO 镜像 — 包含操作系统数据或可引导介质的光盘映像
- 磁盘卷快照 — 实例数据的保存副本，可用于数据恢复或创建新模板

次要存储中的存储项对次要存储范围内所有主机都可用，该范围可以按Zone区域或Region地区定义。

为了使次要存储中的存储项目在整个云环境中对所有主机都可用，您可以除了基于Zone区域的 NFS 二次暂存库之外还添加对象存储。不需要将模板和快照从一个Zone区域复制到另一个Zone区域，这是使用仅有基于Zone区域 NFS 时所需做法。一切均在任何地方都可获得。

对于 Hyper-V 主机，支持 SMB/CIFS 存储。

CloudStack提供插件，可以同时启用OpenStack对象存储（Swift, swift.openstack.org）和Amazon简单存储服务（S3）的对象存储。当使用其中一个存储插件时，您需要为整个CloudStack配置Swift或S3存储，然后为每个Zone区域设置NFS次要暂存库。每个Zone区域中的NFS存储充当一个临时暂存区，在将所有模板和其他次要存储数据转发到Swift或S3之前通过该Zone区域进行传递。支持的对象存储作为云范围内的资源，使得模板和其他数据可在云中任何Zone区域使用。

> 不支持在Region区域中使用异构的次要存储。例如，您不能设置多个Zone区域，一个Zone区域使用NFS作为次要存储，另一个Zone区域使用S3或Swift作为次要存储。

#### 对象存储(Object Storage)

对象存储（也称为基于对象的存储）是一种将数据以对象形式进行管理的数据存储方式。CloudStack管理员可以设置支持的对象存储系统，并将其添加到CloudStack作为一个对象存储池。用户可以在对象存储池中创建桶(bucket)。对象存储的基本单元是对象，无论内容类型如何，任何类型的数据都被保存为一个对象。桶(bucket)是用于存放对象的逻辑容器。

#### 物理网络

添加Zone区域的一部分是设置物理网络。每个Zone区域可以与一个或多个物理网络关联（在高级Zone区域中）。该网络对应于虚拟化主机上的网卡。每个物理网络可以承载一个或多个类型的网络流量。对于基本网络或高级网络创建Zone区域，每个Zone网络可用的流量类型选择会有所不同。

物理网络是Zone区域内实际的硬件和布线。一个Zone区域能够拥有多个物理网络。管理员可以：

- 在一个Zone区域中添加/删除/更新物理网络
- 配置物理网路上的VLANs
- 为了让Hypervisors能够识别，配置名称给该网路
- 配置可用于某一特定物理网路上的服务提供商（防火墙、负载均衡器等）
- 配置传输到某一特定物理网路上的IP地址集合
- 指定在该特定物理网路上传输哪种类型的流量以及其他属性，如网速

##### 基本的Zone区域网络流量类型

当使用基本网络时，Zone区域内只能有一个物理网络。该物理网络承载以下流量类型：

- 访客。当终端用户运行实例时，会产生访客流量。访客实例通过可以称为访客网络的网络相互通信。基本Zone区域中的每个Pod都是一个广播域，因此每个Pod对于访客网络具有不同的IP范围。管理员必须配置每个Pod的IP范围。
- 管理。当CloudStack的内部资源相互通信时，会产生管理流量。这包括主机之间、系统虚拟机（由CloudStack用于在云中执行各种任务的虚拟机）以及任何直接与CloudStack管理服务器通信的其他组件之间的通信。您必须配置系统虚拟机使用的IP范围。

> 我们强烈建议使用单独的网卡来分别处理管理流量和访客流量。

- 公共。基本网络的Zone区域中不存在公共流量。相反，如果您希望实例直接暴露在互联网上，则可以为访客网络分配可公开的可路由的IP空间。
- 存储。虽然标记为“存储”，但这主要涉及次级存储流量，并不影响主存储的流量。这包括实例模板和快照等流量，该流量在次级存储VM和次级存储服务器之间发送。CloudStack使用名为“storage NIC”的单独网络接口控制器（NIC）用于处理存储网络流量。始终在高带宽网络上运行的存储NIC的使用可以实现快速模板和快照复制。您必须配置用于存储网络的IP范围。

在基本网络中，配置物理网络相当简单。在大多数情况下，您只需要配置一个客户网络来传输由客户实例生成的流量。如果您使用NetScaler负载均衡器并启用其弹性IP和弹性负载平衡（EIP和ELB）功能，则还必须配置一个用于传输公共流量的网络。当您添加新的Zone区域时，CloudStack会在用户界面中呈现所需的网络配置步骤给您处理。

##### 基本的Zone 区域访客IP地址

当使用基本网络时，CloudStack将为该pod中的guest分配CIDR范围内的IP地址。管理员必须在该pod上添加一个直接IP范围以实现此目的。这些IP与主机位于同一VLAN中。

##### 高级的Zone区域网络流量类型

当使用高级网络时，区域中可以有多个物理网络。每个物理网络可以承载一个或多个流量类型，并且您需要让CloudStack知道您希望每个网络承载哪种类型的网络流量。高级区域中的流量类型包括：

- Guest（访客）。当终端用户运行实例时，会生成访客流量。客户实例通过称为访客网络的网络相互通信。该网络可以是隔离的或共享的。在隔离的访客网络中，管理员需要保留VLAN范围以为每个CloudStack账号的网络提供隔离（可能是大量VLAN）。在共享的访客网络中，所有客户实例共享一个单一的网络。
- Management（管理）。当CloudStack内部资源相互通信时，会生成管理流量。这包括主机之间、系统虚拟机（由CloudStack用于执行云中各种任务的虚拟机）之间以及任何直接与CloudStack管理服务器通信的组件之间的通信。您必须配置系统虚拟机使用IP范围。
- Public（公网）。公网流量是指云中实例需要访问外部于CloudStack环境之外系统时产生的流量。 客户实例将通过其虚拟路由器将此类流量路由到外部系统进行访问。终端用户可以使用 CloudStack 用户界面获取这些IP地址，以在其访客网络和公共网络之间实现NAT，具体请参阅“管理指南”中的“获取新的IP地址”。公共IP分配给系统虚拟机（包括虚拟路由器）的“Public”接口。

> 在“公共”网络中使用的IP空间可以是真正可公开路由的IP空间（例如，在公共云设置中），也可以是任何其他公司内部（RFC 1918）IP空间，该空间未与其他CloudStack网络一起使用（例如，在私有云设置中）。

- 存储。虽然标记为“存储”，但这主要是关于次要存储，并不影响主存储的流量。这包括实例模板和快照之间在次要存储虚拟机和次要存储服务器之间传输的流量。CloudStack使用一个名为“storage NIC”的单独网络接口控制器（NIC）用于处理存储网络流量。始终在高带宽网络上运行的storage NIC可实现快速模板和快照复制。您必须配置用于Storage Network的IP范围。

这些流量类型可以分别在不同的物理网络上，也可以根据一定的限制进行组合。当您使用UI中的“添加区域向导”来创建新Zone区域时，系统会引导您只做出有效的选择。

##### 高级的Zone区域访客IP地址

当使用高级网络时，管理员可以创建额外的网络供访客使用。这些网络可以跨越Zone区域，并对所有账户可用，或者它们可以限定在单个账户中，只有指定的账户才能创建连接到这些网络的访客。这些网络由VLAN ID、IP范围和网关定义。如果需要，管理员可以预留数千个这样的网络。此外，管理员还可以为非CloudStack实例和服务器保留一部分IP地址空间。

##### 高级的Zone区域公有IP地址

当使用高级网络时，管理员可以创建额外的公共网络供访客使用。这些网络可以跨Zone区域，并对所有账户可用，或者它们可以限定为单个账户，在这种情况下，只有指定的账户才能创建连接到这些网络的访客。这些网络由VLAN ID、IP范围和网关定义。如果需要，管理员可以提供数千个这样的网络。

##### 系统保留的IP地址

在每个Zone区域中，您需要为管理网络配置一系列保留的IP地址。该网络用于CloudStack管理服务器与各种系统虚拟机之间的通信，例如次要存储虚拟机、控制台代理虚拟机和DHCP。

保留的IP地址必须在整个云中是唯一的。例如，一个Zone区域中的主机不能与另一个Zone区域中的主机具有相同的私有IP地址。

Pod中的主机被分配了私有IP地址。这些通常是RFC1918标准定义的地址。控制台代理和次要存储系统虚拟机也会在它们所创建所属pod范围内被分配私有IP地址。

确保计算服务器和管理服务器使用超出系统保留IP范围之外的IP地址。例如，假设系统保留IP范围从192.168.154.2开始到192.168.154.7结束。CloudStack可以使用 .2 到 .7 作为系统虚拟机 IP 地址。这样剩下 pod CIDR 的其余部分, 即从 .8 到 .254, 可供管理服务器和 hypervisor 主机使用

在所有的Zones中：

为每个 pod 中的系统提供私有 IP，并在 CloudStack 中进行配置。

对于 KVM 和 XenServer，建议每个 pod 每台主机分配一个私有 IP。如果您预计 pod 会增长，请现在添加足够多的私有 IP 来适应增长。

在一个Zone中使用高级网络：

对于具有高级网络功能的Zone区域，我们建议为您的客户总数提供足够的私有IP地址，再加上所需的CloudStack系统虚拟机所需的IP地址。通常，系统虚拟机需要额外约10个IP地址。有关系统虚拟机的更多信息，请参阅管理员指南中关于使用系统虚拟机的部分。

当使用高级网络时，在每个Pod中可用的私有IP地址数量取决于在该Pod中运行节点上使用哪种Hypervisor。Citrix XenServer和KVM使用本地链路地址(link-local addresses)，在理论上可以在地址块内提供超过65,000个私有IP地址。随着时间推移，随着Pod规模扩大，这应该足够满足任何合理数量主机以及来访客拟路由器所需的IP地址。相比之下，VMWare ESXi则使用任何由管理员指定子网划分方案，并且典型情况下每个Pod只提供255个IP地址。由于这些被物理设备、访客虚拟路由器和其他实体共享，因此在扩展运行ESXi节点的Pod时可能会耗尽私有IP。

为了确保在使用高级网络功能并且采用ESXi节点运行方式时能够适当扩展私有IP空间，请使用以下一种或两种技术：

1. 为子网指定更大的CIDR块。带有/20后缀的子网掩码将提供超过4,000个IP地址。

2. 创建多个Pod，每个Pod都有自己的子网。例如，如果创建10个Pod，并且每个Pod具有255个IP地址，则将提供2,550个IP地址。

## 选择一个部署架构

部署中使用的架构将根据部署的规模和目的而有所不同。本节包含了部署架构的示例，其中包括适用于测试和试验性部署的小规模部署以及适用于生产环境下具备完全冗余且大规模设置的方案。
### 小规模部署

![[Pasted image 20240218171612.png]]

这个图示了一个小规模CloudStack部署的网络架构。

- 防火墙提供与互联网的连接。防火墙配置为NAT模式。防火墙将来自互联网的HTTP请求和API调用转发到管理服务器。管理服务器位于管理网络上。
- 一台二层交换机连接所有物理服务器和存储设备。
- 一台NFS服务器同时充当主存储和次要存储。
- 管理服务器连接到管理网络上。

### 大规模冗余部署

![[Pasted image 20240218172050.png]]

这个图示了一个大规模CloudStack部署的网络架构。

- 数据中心的核心是一个三层交换机层。应该部署类似VRRP的路由器冗余协议。通常高端核心交换机还包括防火墙模块。如果三层交换机没有集成防火墙功能，也可以使用单独的防火墙设备。防火墙配置为NAT模式。防火墙提供以下功能：

     - 将来自互联网的HTTP请求和API调用转发到管理服务器上。管理服务器位于管理网络上。

     - 当云跨越多个Zone区域时，防火墙应启用站点到站点VPN，以便不同Zone区域中的服务器可以直接相互访问。

- 每个Pod都建立了一个二层接入交换机层（接入层，因为是一个机架上）。可以堆叠多个交换机以增加端口数量。无论哪种情况，都应该部署冗余对的二层交换机。
- 管理服务器集群（包括前端负载均衡器、管理服务器节点和MySQL数据库）通过一对负载均衡器连接到管理网络。
- 次要存储服务器连接到管理网络。
- 每个Pod都包含存储和计算服务器。每台存储和计算服务器应具有与独立二层接入交换机相连的冗余NICs。
### 分离的存储网络

在前一节中描述的大规模冗余设置中，存储流量可能会超载管理网络。为部署提供一个独立的存储网络是可选的。像 iSCSI 这样的存储协议对网络延迟非常敏感。一个独立的存储网络确保了访客网络流量争用不会影响存储性能。
### 多个管理服务器节点

CloudStack管理服务器部署在一个或多个前端服务器上，这些服务器连接到一个单独的MySQL数据库。可选地，一对硬件负载均衡器可以分发来自Web的请求。可以使用MySQL复制在远程站点部署备份管理服务器集合以增加灾难恢复能力。

![[Pasted image 20240218172650.png]]

管理员必须决定以下事项。

- 是否使用负载均衡器。
- 部署多少个管理服务器。
- 是否部署MySQL复制以实现灾难恢复。
### 多站点部署

CloudStack平台通过使用Zone区域可以很好地扩展到多个站点。下图显示了一个多站点部署的示例。

![[Pasted image 20240218172855.png]]

数据中心1承载主要的管理服务器和区域1。MySQL数据库实时复制到数据中心2的次要管理服务器安装。

![[Pasted image 20240218172940.png]]

该图示了一个具有独立存储网络的设置。每个服务器都有四个网卡，其中两个连接到Pod级别的网络交换机，另外两个连接到存储网络交换机。

配置存储网络有两种方式：

- 对于NFS，可以部署绑定网卡和冗余交换机。在NFS部署中，冗余交换机和绑定网卡仍然会导致一个网络（一个CIDR块+默认网关地址）。
- iSCSI可以利用两个独立的存储网络（每个都有自己的CIDR块和默认网关）。多路径iSCSI客户端可以在独立的存储网络之间进行故障转移和负载平衡。

![[Pasted image 20240218173131.png]]

这个图示了NIC绑定和多路径I/O（MPIO）之间的区别。NIC绑定配置只涉及一个网络。MPIO涉及两个独立的网络。
### 选择一个Hypervisor

CloudStack支持许多流行的虚拟化平台。您的云环境可以完全由运行单一虚拟化平台的主机组成，也可以使用多个不同的虚拟化平台。每个主机集群必须运行相同的虚拟化平台。

如果您已经有一批正在运行特定虚拟化平台的节点，那么您选择使用哪种虚拟化平台已经确定了。如果您从零开始建立云环境，则需要决定哪种虚拟化软件最适合满足您的需求。关于每种虚拟化平台各自优势的讨论超出了我们文档范围之外。然而，了解CloudStack支持每种虚拟化平台的哪些功能将对您有所帮助。以下表格提供了这方面信息。

![[Pasted image 20240218173723.png]]

#### Hypervisor对主存储的支持

以下表格显示了不同虚拟化管理程序的存储选项和参数。

![[Pasted image 20240218173859.png]]

XenServer使用集群LVM系统将实例镜像存储在iSCSI和Fiber Channel卷上，并且不支持虚拟化程序中的超额配置。然而，存储服务器本身可以支持薄配置。因此，CloudStack仍然可以通过运行在薄配置的存储卷上来支持存储超额配置。

KVM支持“共享挂载点”存储。共享挂载点是给定集群中每个服务器本地的文件系统路径。该路径必须在集群中的所有主机上相同，例如/mnt/primary1。假设这个共享挂载点是一个类似OCFS2的集群文件系统。在这种情况下，CloudStack不会尝试像NFS那样挂载或卸载存储。CloudStack要求管理员确保可用性。

对于NFS存储，CloudStack管理超额配置。在这种情况下，全局配置参数storage.overprovisioning.factor控制超额配比程度。这与虚拟化程序类型无关。

vSphere、XenServer和KVM都可以选择使用本地存储作为主要存储选项。当启用本地磁盘选项时，在每台主机上自动创建一个本地磁盘存储池以供使用（例如虚拟路由器等系统虚拟机），请将system.vm.use.local.storage设置为true以进行全局配置。

CloudStack支持在集群中使用多个主要存储池。例如，您可以为主要存储配置2个NFS服务器。或者当第一个接近容量时，您可以先配置1个iSCSI LUN，然后再添加第二个iSCSI LUN。

### 最佳实践

部署云计算是具有挑战性的。在选择技术方案时有很多不同的选择，而CloudStack在配置上非常灵活，可以通过多种方式组合和配置所选技术。本节提供了关于云计算部署的建议和要求。

这些建议应被视为建议而非绝对规定。然而，我们鼓励任何计划在这些指南之外构建云计算系统的人寻求项目邮件列表上的指导和建议。

#### 最佳实现的处理

- 强烈建议使用模拟生产环境的分阶段系统(staging system)。如果已对CloudStack进行了定制，这一点尤为重要。
- 安装、测试版和学习系统需要充足的时间。基本网络安装可以在几小时内完成。高级网络安装通常需要数天来进行首次尝试，而复杂的安装则需要更长时间。对于完整的生产系统，请至少留出4-8周用于测试版以解决所有集成问题。您可以从cloudstack-users邮件列表中获得其他用户的帮助。

#### 建立最佳实践

- 每个主机应配置为仅接受来自诸如CloudStack管理服务器或您的网络监控软件等知名实体的连接。
- 如果需要达到一定的交换机密度，可以在每个Pod中使用多个集群。
- 主存储挂载点或LUN的大小不应超过6 TB。最好是在一个集群中拥有多个较小的主存储元素，而不是一个大型元素。
- 在导出主存储上的共享时，请通过限制可以访问存储的IP地址范围来避免数据丢失。请参阅“Linux NFS on Local Disks and DAS”或“Linux NFS on iSCSI”。
- NIC绑定易于实施，并提供更高可靠性。
- 当使用能够支持相对更多实例的较大服务器时，通常建议使用10G网络进行存储访问。
- 通常应以RAM为基础对访客进行容量建模。存储和CPU可能会被过度分配，但RAM则不能。 RAM通常是容量设计中限制因素。
- （XenServer）配置XenServer dom0设置以将更多内存分配给dom0。这样可以使XenServer处理更大数量的实例。我们建议为XenServer dom0分配2940 MB RAM。有关如何执行此操作的说明，请参见http://support.citrix.com/article/CTX126531. 该文章涉及XenServer 5.6版本，但相同的信息适用于XenServer 6.0版本。

#### 维护最佳实践

- 监控主机磁盘空间。许多主机故障是因为主机的根目录磁盘被未充分轮换的日志填满。

- 监控每个集群中实例的总数，并在接近虚拟化程序能处理的最大值时禁用对该集群的分配。确保留出安全余量，以便考虑到一个或多个主机故障可能会增加其他主机上实例负载，因为实例正在重新部署。请查阅所选虚拟化程序的文档，找到每个主机允许的最大实例数量，然后使用CloudStack全局配置设置将其设定为默认限制。监控每个集群中实例活动，并保持总数低于允许偶尔发生主机故障的安全水平。例如，如果集群中有N台主机，并且您希望任何给定时间内都可以关闭一台主机，则可以在集群中允许的实例总数最多为（N-1）\*（per-host-limiy）。一旦一个集群达到这个实例数量，请使用CloudStack用户界面禁用对该集群的分配。

> 缺乏最新的热修复补丁可能导致数据损坏和实例丢失。

- 确保应用了由虚拟化供应商提供的所有热补丁。通过虚拟化供应商的支持渠道跟踪虚拟化程序补丁的发布，并在其发布后尽快应用这些补丁。CloudStack不会跟踪或通知您所需的虚拟化程序补丁。确保您的主机完全更新到提供的虚拟化程序补丁版本是至关重要的。如果系统未及时更新到最新版本，虚拟化供应商可能会拒绝提供支持。

## 网络建立

相当复杂 [Basic and Advanced Networking — Apache CloudStack 4.19.0.0 documentation](https://docs.cloudstack.apache.org/en/4.19.0.0/conceptsandterminology/network_setup.html)

暂时不翻译

## 存储建立

相当复杂 [Introduction — Apache CloudStack 4.19.0.0 documentation](https://docs.cloudstack.apache.org/en/4.19.0.0/conceptsandterminology/storage_setup.html)

暂时不翻译


## 不同网络模式的架构图


#### 基本Zone网络的共享网络模式(IP私有地址空间)

![[17ad9ee3eccc25add208d1d534deaf5.jpg]]

与高级Zone网络的共享网络模式(私有IP地址空间)很像，唯一的区别就是Pod不是以VLAN划分的。其他都一样

#### 基本Zone网络的共享网络模式(公有IP地址空间)

![[0c768a1c0c46ac215233e64e443b46e.jpg]]

与高级Zone的共享网络模式（公有IP地址空间）很像，但是唯一有一点区别就是，Pod不是以VLAN划分的。其他都一样/

#### 高级Zone网络的共享网络模式(私有IP地址空间)

![[910b7e9a5d4a0bd867fd487de136f0b.jpg]]

有多个物理网关设备，网关设备充当不同VLAN的路由。每个VLAN子网对应一个网关设备，也有自己的虚拟路由器，这里的虚拟路由器没有路由功能，只有DNS DHCP功能。不同的物理网关设备有自己的公网IP地址端。物理网关设备之间不共享公网IP地址范围。每个VLAN子网对应不同的POD机架，并且其中的VM实例，有自己的私有IP地址段。

#### 高级Zone网络的共享网路模式(公有IP地址空间)

![[1c687e644871c63d1df7c455b5aca83.jpg]]

可以看到有多个物理网关设备，每个网关设备都有共享一组公网IP范围，公网IP范围在一个CIDR中。网关充当不同机架Pod网络的路由功能。每个Pod对应一个自己的网关，每个Pod都对应一个自己的VLAN。每个Pod有自己的虚拟路由器，只是这里的虚拟路由器没有路由功能，只是充当DNS，DHCP的功能。不同Pod中的实例是分配的公网IP地址范围。

#### 高级Zone网络的隔离网络模式

![[d10b9d0dacd3ab5437ae1f030dd46ee.jpg]]

可以看到，隔离网络模式只有一个物理网关设备，隔离的网络有多个，隔离网络的出口是虚拟路由器，每个虚拟路由器有自己的公网IP，虚拟路由器有端口转发，static NAT的功能到自己对应的隔离网络中的VM实例上。

#### 高级Zone网路的VPC模式

![[0c81947c3fd35b6404bd10464b2cd8c.jpg]]

一个物理设备网关出口，网关不对应任何隔离的子网，而是对应VPC子网的虚拟路由器，虚拟路由器对应不同的VPC网络。不同的VPC网络下面有不同的VLAN，一个VPC网络下面可以有多个VLAN，不同的VPC之间的VLAN编号不能冲突。VLAN下面才有各个VM实例。  VPC还至此站点到站点的VPN功能，也就是其他数据中心与这个数据中心的网络打通。

#### 高级Zone网络下的L2网络

![[d6d8a9d87bc73222e492bb55ee484bf.jpg]]

所有的物理设备，与网路都是由管理员手动配置。