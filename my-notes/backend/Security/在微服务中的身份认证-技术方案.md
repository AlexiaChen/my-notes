
身份认证(Authentication)是作为访问控制系统的一部分，验证用户或其他实体身份的实践。微服务应用程序具有多个独立服务，每个服务执行特定预定义功能。在本文中，我们将讨论微服务架构中认证的主要挑战、您可以使用的方法以及常见技术如SSO和JWT。

微服务中的身份验证可以有三个含义：

- 对访问微服务应用程序的终端用户Client进行身份验证    （对终端用户进行身份认证）
- 对连接到其他微服务的微服务进行身份验证  （对内部微服务进行身份认证）
- 对通过API连接到您的微服务的外部服务进行身份验证 （对外部第三方服务进行身份认证）

## 单体应用的身份认证和微服务下的身份认证

一个单体应用由一个不可分割的单元组成。通常包括客户端用户界面、服务器端应用程序和数据库，所有这些都紧密集成在一起，以提供所有功能。它具有所需的所有资源，因此在单体应用中不需要进行身份验证。只有当用户需要访问该应用时才需要处理身份验证（也就是用户登录）。

相比之下，微服务应用是通过API集成的多个独立组件。每当一个微服务与其他微服务通信时，必须确保其经过身份验证。身份验证确保只有合法的服务和用户可以访问每个微服务。此外，就像在单体应用中一样，还需要对终端用户进行身份验证。

正确实施时，认证和授权是微服务应用的重要资产。它作为对所有访问资源进行额外安全检查的手段，防止安全漏洞和盲点出现。

## 微服务身份认证的挑战

在微服务架构中，每个微服务实现一个特定的功能或业务逻辑的一部分。每个微服务访问请求必须经过身份验证和批准，这带来了几个挑战：

- 中心依赖性 - 身份验证和授权逻辑必须由每个微服务单独处理。您可以在所有微服务中使用相同的代码，但这要求所有微服务都支持特定的语言或框架。
- 违反单一职责原则 - 微服务应该只完成一个功能。如果将全局身份验证和授权逻辑添加到微服务中，它们现在执行额外的功能，使其可靠性降低且更难管理。
- 复杂性 - 在微服务中进行身份验证和授权可能导致非常复杂的场景。考虑到可能有用户、微服务和第三方系统访问每个微服务

> 其实以上本质上是要求一个高可用的集中式认证授权服务被独立出来。

## 微服务认证的方法

你可以使用以下任意一个。

#### 边缘级的授权

在简单的场景中，授权仅发生在边缘，通常使用API网关。您可以使用API网关来集中认证和授权所有下游微服务。该网关强制执行每个微服务的身份验证和访问控制。在这种情况下，NIST建议实施缓解控制，例如微服务之间的相互认证，以防止对内部服务进行直接匿名连接。

这种策略具有以下不利之处：

- 安全性较低 - 如果攻击者通过了网关，则可以自由访问任何微服务。作为单一访问点的API网关违反了“深度防御”原则。
- 管理更加困难 - 如果系统复杂且具有多个角色和访问控制规则，则将所有授权决策推送到API网关可能变得难以管理。
- 开发团队的权限受限 - 通常情况下，运维团队设置API网关，因此开发团队无法直接更改权限。这种断裂可能导致沟通和流程开销增加。


> 好像API网关的方式是微服务认证授权的主流
#### 服务级的授权

该策略使得每个微服务能够进行直接的身份验证和授权。优势在于每个微服务都可以更好地控制并执行其访问控制策略。一个基于服务级别的授权架构包括以下组成部分：

- 策略管理点——允许管理员创建、管理和测试访问规则。
- 策略决策点——检查当前请求适用哪种访问控制策略，并评估是否批准或拒绝该请求。
- 策略执行点——提供访问决定，对特定请求执行访问政策。
- 策略信息点——允许系统中的元素检索有关政策的数据，或者接收账户属性以进行政策决策。

#### 外部实体身份传播

这个策略可以在考虑用户上下文的同时进行授权决策。例如，它可以根据用户ID、用户角色或组、用户位置、时间或其他参数来改变授权决策。

为了基于实体上下文执行身份验证，您必须接收有关最终用户的信息并将其传播到下游微服务。实现这一目标的简单方法是获取在边缘处接收到的访问令牌，并将其传递给各个微服务。该策略提供了对微服务身份验证最精细级别的控制。然而，它有两个主要缺点：

- 不安全 - 令牌的内容与所有微服务共享，因此攻击者可以破坏它。一个可能的解决方案是通过可信任的发行者对令牌进行签名。
- 它要求内部微服务支持多种身份验证技术，如JWT、OIDC或cookies。

## 微服务认证技术

一旦您决定了微服务身份验证的方法，以下是几种可以用来实现微服务身份验证的技术方法。

#### 单点登录(SSO)

SSO允许用户或实体登录一次并获得对多个系统的访问权限。在微服务架构的背景下，SSO可以有两个含义： 

1. 对终端用户进行身份验证 - 终端用户非常方便地只需一个中央登录，最好使用现有凭据，而不需要新的凭据来登录您的应用程序。您可以使用身份和访问管理（IAM）解决方案设置用户数据库，并为面向用户的微服务定义权限。 微服务可以将用户重定向到IAM系统进行身份验证，接收加密的SSO令牌，然后在后续尝试中使用该令牌来登录用户。微服务还可以使用IAM系统进行授权，并且SSO令牌可以指定哪些资源是允许该用户访问的。
2. 对微服务进行身份验证 - 您还可以为需要连接到其他微服务或通过API请求访问外部服务的微服务启用SSO。这里需要授权软件实体或服务账户，而不是人类用户。您可以使用相同的IAM解决方案。当软件实体需要访问时，它会被重定向到IAM，并且IAM系统提供了一个他们以后可用于API调用的SSO令牌。

#### JWT

JSON Web Token（JWT）提供了一种加密和安全的方式，用于在客户端与微服务应用之间共享一组声明或属性。JWT还可以保护服务之间的通信，或者在微服务之间传递终端用户上下文和数据。

例如，您可以使用JWT令牌传递调用微服务的ID、客户端的ID或发起请求的系统。您还可以将授权和身份验证属性存储在JWT令牌中，并在多个客户端和服务器之间共享它们。


#### OAuth API认证

OAuth 2.0 提供了一种行业标准的协议，用于在分布式系统中授权用户。在微服务的背景下，OAuth 2.0 客户端凭证流支持 API 客户端和 API 服务器之间的安全服务器到服务器通信。OAuth 框架减轻了开发人员的负担，消除了在每个微服务中构建自己的身份验证机制的需要。

OpenID Connect（OIDC）扩展了 OAuth，添加了联合身份验证功能，使得设置委派授权成为可能。这两个层级共同允许开发人员构建与多个身份提供者交互的系统。使用 OIDC 和 OAuth 2.0 还可以通过向用户信息终点发送访问令牌来检索用户 ID。可以使用 OIDC 查找确定到达此终点的路径。