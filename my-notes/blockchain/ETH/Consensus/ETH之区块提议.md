这篇主要讲ETH的区块提议(block proposals)

每12秒就有一个区块诞生。你有没有想过，一个区块是如何产生的？或者它是如何被网络接受并添加到区块链中的？

想知道一切将如何改变吗？

![[Pasted image 20221009151641.png]]

ETH是世界计算机，大约网络上有1000个节点运行维护者网络。每个节点本地都跑着一个EVM副本。每个本地EVM都保持着同步，任何节点的状态就是整个ETH网络的状态。

EVM是一个孤立的单元；它不能接触到其他节点并与另一个EVM直接互动。

相反，EVM附属于一个共识机制，该机制负责在节点之间进行通信，保证了 以太坊运行和更新EVM。

一个共识机制会做一些事情。

- 选择一个leader（也就是区块提议者，block proposer）
- 允许一个提议者向网络提交对EVM（区块）的改变
- 允许网络确认该区块是有效的
- 提供可信的安全保证

最初，世界计算机使用工作证明（PoW）作为其共识机制。

今天，以太坊已经用权益证明（PoS）取代了PoW。[[ETH之共识系统]]

只是由于PoW的运作方式，区块提议者的选择非常直接；所有节点都是潜在的区块提议者，但只有第一个解开谜题的人赢得特权。[[ETH之共识系统#^37e485]]

也许从PoW到PoS最大的变化是，PoS完全消除了这些难题；在PoS中，区块提议者是随机选择的。

在我们深入研究之前，让我们回顾一下几个关键概念。

以太坊中的时间

- slot：12秒，在此期间，区块提议者（应该）广播他们的区块。
- epoch：32个slots = 6.4分钟

[[ETH之时间-Slots和Epochs]]

以太坊中的随机性

可信的随机性对PoS的安全设计至关重要，特别是在validator的分配方面（包括区块提议者）。以太坊使用一个叫做RANDAO的程序来生成 "足够好 "的随机性。[[ETH之随机性和RANDAO]]

在每个epoch的开始。以太坊执行一个信标链(beacon chain)洗牌(shuffle)，为下一个epoch提供validator分配（包括区块提议）。

信标链洗牌是一个前瞻功能；它提供提前1个epoch的任务，以便于准备。

虽然区块生产者实际上是在上一个epoch开始时设置的，但认为在每个slot开始时进行分配是有用的。

因此，在每个slot的开始，会随机选择一个validator。

![[Pasted image 20221009152816.png]]

提议者(block proposer)通过填写所有的区块头开始构建区块。

区块头包含所有与信标链和PoS共识有关的信息。它不包含任何关于EVM的数据；事实上，EVM不能（直接）查询这些数据。

![[Pasted image 20221009152911.png]]

大多数区块头的数据是直接的和/或可以使用下面的会说到的东西来识别

提议者(proposer)和出席证明者(attester)的削减slashing很有意思；validator因为包括有效的事件（identical）而得到一个小的 "告密者（whistleblower） "奖励。

接下来，validator将转向执行引擎，也就是持有EVM的过程。

事实上，执行引擎/执行层几乎与当时PoW的情况相同 。

![[Pasted image 20221009153320.png]]

理解区块构造的最简单方法是只看一个区块。

共识层包含整个执行层（之前是整个PoW区块）。[[ETH的PoS区块]]

最后，提议者（block proposer）完成了区块的准备工作，并将其广播到网络上。绝大多数情况下，该区块将是完全有效的，并且很容易被以太坊其余的网络节点接受。

![[Pasted image 20221009153510.png]]

网络对潜在的区块进行验证，并通过一个称为证明(attestation)的过程将其确认到区块链中。

简而言之，证明（attestation）是一个正式的区块投票过程。有效的attestation会得到奖励，无效的attestation会受到惩罚（通过slashing）。[[ETH之证明Attestation]]


attestation的关键步骤之一是聚合，这是一个将成千上万的数字签名合并成单一的、浓缩的数据的过程。

attestation是很棘手的；它涉及到在一个繁忙的网络中对成千上万的数据包进行社交和处理。[[ETH之证明Attestation#^cd083c]]

以太坊以两种方式减轻了这种压力。

- 证明是冗余运行的；许多不同的方面将致力于收集尽可能多的签名。
- 网络将接受延迟一个epoch的聚合（奖励减少）。

以太坊的签名越多越安全，因此它鼓励收集尽可能多的签名。该协议将为更多的签名支付更多的ETH代币。

因此，区块提议者收集尽可能多的签名，并将它们添加到区块中。

现在你可能会问："如果该区块已被提出，生产者如何添加证明？"

实际上，它们被包括在一个区块之后。因此，如果一个区块在slot N被提出，该区块的attestation将被附在slot N+1的区块中。

实际上，attestation过程是在提议者创建区块头时发生的--它只是针对前面的块发生的。

不管怎么说，如果我们放大一点，我们可以认为这一点没有意义。一个被证明的区块是区块链的一部分。

在结束之前，我们将简要地讨论一下在 以太坊路线图中的一个重大变化。

问题是：一些validators在构建区块方面比其他validators好得多。(强者恒强，越有钱的validator出块概率就比穷的更大)

在PoS下，一些validators会比其他validators获得更多的股权，最终占领网络。

解决办法: 埋头苦干的proposer与builder分离（PBS）。

未来世界计算机的升级将重新配置这个过程，将区块建造者和区块提议者分开（目前的情况是，block proposer就充当了block builder这个角色）。block builder可以是专门的、集中的实体，把他们的区块"卖"给下一个区块提议者（block proposer）。[[ETH路线图之Proposer与Builder分离]]

虽然以太坊已经转变为PoS了，但是以太坊的PoS优化之路还在继续。