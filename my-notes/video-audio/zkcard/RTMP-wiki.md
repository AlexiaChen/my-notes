## 简介

实时信息传输协议（RTMP）是一种用于在互联网上传输音频、视频和数据的通信协议。最初是由Macromedia开发的专有协议，用于Flash Player和服务器之间的流媒体，Adobe（收购了 
Macromedia）已经发布了该协议的一个不完整版本的规范，供公众使用。

RTMP协议有多种变种。

1. RTMP本身，即 "普通 "协议，在传输控制协议（TCP）之上工作，默认使用端口号1935。
2. RTMPS，即通过传输层安全（TLS/SSL）连接的RTMP。
3. RTMPE，这是使用Adobe自己的安全机制加密的RTMP。虽然实现的细节是专有的，但该机制使用行业标准的加密基元）。
4. RTMPT，它被封装在HTTP请求中以穿越防火墙。RTMPT经常被发现利用TCP端口80和443的明文请求来绕过大多数公司的流量过滤。封装的会话可能包含纯RTMP、RTMPS或 
RTMPE数据包。

5. RTMFP，是通过用户数据报协议（UDP）而不是TCP的RTMP，取代了RTMP Chunk Stream。安全实时媒体流协议套件由Adobe系统公司开发，使最终用户能够直接连接和通信。
彼此之间的通信（P2P）。

虽然RTMP的主要动机是作为播放Flash视频的协议，但它也用于其他一些应用，如Adobe LiveCycle Data Services ES。

## 基本操作

RTMP是一个基于TCP的协议，它保持持久的连接并允许低延迟的通信。为了顺利地传送数据流并尽可能多地传输信息，它将数据流分割成片段，其大小在客户端和服务器之间动态地协商。
客户端和服务器之间动态协商。有时，它保持不变：音频数据的默认片段大小为64字节，视频数据和大多数其他数据类型为128字节。来自不同数据流的片段可以交错使用，并在一个连接上复用。

对于较长的数据块，该协议因此只为每个片段携带一个字节的头，所以产生的开销非常小。然而，在实践中，单个片段通常不会被交错。相反，交错和复用是在数据包层面上进行的，RTMP 数据包在几个不同的活动通道上交错，以确保每个通道满足其带宽、延迟和其他服务质量要求。以这种方式交错的数据包被视为不可分割的，而不是交错在片段级的交错。

RTMP定义了几个虚拟通道，数据包可以在这些通道上发送和接收，这些通道相互独立运行。例如，有一个处理RPC请求和响应的通道，一个视频流数据的通道，一个音频流数据的通道。流数据的通道，一个用于带外控制信息（片段大小协商等）的通道，等等。在一个典型的RTMP会话中，在任何时候都可能有几个通道同时活动。当RTMP数据被编码时，会产生一个数据包头。该 数据包头指定，除其他事项外，它要发送的通道的ID，它产生的时间戳（如果需要），以及数据包有效载荷的大小。这个头之后是数据包的实际有效载荷内容。

在通过连接发送之前，根据当前商定的碎片大小对其进行碎片化。数据包头本身从不被分割，其大小也不计入数据包的第一个片段中的数据。换句话说，只有实际的数据包有效载荷 (媒体数据)会被分割。

在更高层次上，RTMP封装了MP3或AAC音频和FLV1视频多媒体流，并能使用行动消息格式进行远程程序调用（RPC）。任何需要的RPC服务都是异步进行的，使用单一的客户/服务器 请求/响应模式，这样就不需要实时通信了

### 加密

RTMP会话可以使用两种方法中的一种进行加密。

- 使用行业标准的TLS/SSL机制。底层的RTMP会话被简单地包裹在一个正常的TLS/SSL会话中。
- 使用RTMPE，它将RTMP会话包裹在一个较轻的加密层中。

### Http隧道

在RTMP隧道（RTMPT）中，RTMP数据被封装并通过HTTP交换，来自客户端（本例中为媒体播放器）的消息被发送到服务器的80端口（HTTP的默认端口）。

虽然RTMPT中的消息由于HTTP头而比同等的非隧道式RTMP消息要大，但RTMPT可以促进RTMP在非隧道式RTMP不可能使用的情况下的使用，例如，当客户端位于阻止非HTTP和非HTTPS出站流量的防火墙之后。

该协议的工作方式是通过POST URL发送命令，并通过POST主体发送AMF消息。一个例子是

```txt
POST /open/1 HTTP/1.1
```

以上主要是打开一个链接。

## 包结构

数据包通过TCP连接发送，该连接首先在客户和服务器之间建立。它们包含一个头和一个body，在连接和控制命令的情况下，body是用行动消息格式（AMF）编码的。

![[Pasted image 20220726131001.png]]

报头分为基本报头（在图中显示为与其他部分分离）和块状信息报头。基本报头是 基本头是数据包中唯一不变的部分，通常由一个复合字节组成，其中最重要的两个bit是Chunk类型（规范中的fmt），其余的形成 "流ID"。
根据前者的值，消息头的一些字段可以省略，其值来自以前的数据包，同时取决于后者的值。

基本头可以用一个或两个额外的字节来扩展（如图中总共有三个字节的情况（c））。如果基本头(BH)剩下的六个比特的值(最不重要的)是0的话，那么该文件就会被视为 "不存在"。

(最不重要的）为0，那么BH是两个字节，代表从流ID64到319（64+255）；如果他的值为1，那么BH是三个字节（最后两个字节被编码为16位小端）。
并代表从流ID64到65599（64465535）；如果数值为2，则BH为一个字节，并保留给低级协议控制信息和命令。分组信息 头包含元数据信息，如消息大小（以字节为单位）、时间戳Delta和消息类型。这最后一个值是一个单字节，定义了数据包是否 是一个音频、视频、命令或 "iow级 "RTMP数据包，如RTMP Ping。