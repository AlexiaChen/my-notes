
## 前言

编写设计文档，有助于设计者能理清思路，理清系统背后的各种取舍，这样也可以帮助新人快速了解整个系统。在Google里面，软件工程师在开始一项功能，从小到大都需要编写一份设计文档的，而且设计文档还需要被其他工程师review。[谷歌软件工程师是怎样写设计文档的？ - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/219907381)  [(19 封私信 / 80 条消息) 在谷歌（Google）工作是怎样一番体验？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/24290336/answer/1542971035) 
我当时在harmony工作的时候，我发现我的直属Boss(他是从google出来的)，他也会有习惯先写一份设计文档，只是没有Google那么严格规范，比较随意。都是都有一份类似的蓝图设计，以及一些问题和取舍被描述。比如这一份设计文档 [Design Change and Optimizations for 1-Second Finality · Issue #3722 · harmony-one/harmony (github.com)](https://github.com/harmony-one/harmony/issues/3722) 

我的前前Boos，也是一位区块链架构师，我第一次入门区块链，就是进去他自己从零开始写的FnFn区块链项目开始的，我也问过他相关的问题，怎样build system，他说了除了大量看别人的源码之外，就是在写代码前，先梳理下需求和功能，先想清楚怎样实现，其实大意也就是要写一份设计文档了，因为设计文档的内容也需要包含这些。

我看了几篇文章的理解就是，编写Design doc的首要目的，是要阐明背景的，系统的来龙去脉，更多的是展示What和Why，而不是How。在系统设计中，有些时候让人理解Why，What是比How重要得多的，这个话题其实已经被很多网络上的各种大神讨论过无数遍了。 所以设计文档展示的是一个high-level的设计，是一份蓝图。这里的设计文档是不需要多么详细的。

## How to Write a Design Document

[How to Write a Design Document (berkeley.edu)](https://people.eecs.berkeley.edu/~kubitron/courses/cs162-F06/design.html)

这篇是Berkeley一门课程里面，教大家如何编写设计文档的说明，是从一个小作业开始的。非常值得了解阅读。

### 概览

- 每个设计文件的价值是项目的40%。虽然它可能只占你在项目上花费的时间的40%以下，但你应该非常认真地对待它。
- 设计基本上是项目中最重要的部分。有一个好的项目设计，简直可以将你的总编码时间减少10倍。
- 设计文件的长度应该是2000到4000字左右。如果超过5000字，我们就不会读它。因此，请保持简短，切中要害。
- 设计文件将以PDF、HTML或文本格式在线提交。我们鼓励你使用你喜欢的文字处理器来制作你的设计文件，但你必须在完成后将其转换为PDF或文本。
- 这里有一个样本项目 [Sample Project (berkeley.edu)](https://people.eecs.berkeley.edu/~kubitron/courses/cs162-F06/sample-project.html) 和它的设计样本 [Sample Design (berkeley.edu)](https://people.eecs.berkeley.edu/~kubitron/courses/cs162-F06/sample-design.html) 。不过，这个样本项目只是你的项目长度的一小部分。

### 设计文档有哪些内容

设计文档是对所提出的问题的一个完整的高级解决方案。它应该足够详细，以至于已经了解这个问题的人可以出去为这个项目编码，而不需要做出任何重大的决定。此外，如果这个人恰好是一个有经验的编码员，他们应该能够在几个小时内使用设计文件来编码解决方案（不一定包括调试）。

那么，到底要写些什么呢？

- 对你的解决方案的高级描述，包括设计决策和数据结构
- 所有新类、程序和全局/类变量的声明
- 所有新程序的描述（除非你能从名称中准确地知道它是做什么的），包括程序的目的，以及对它如何工作的解释和/或伪代码

例如，这是我为现有的Condition::Wait编写的伪代码。

```c
void Condition::Wait()  
   waiter = new Semaphore, initially 0  
   append waiter to waitQueue  
   conditionLock->Release()  
   waiter->P()  
   conditionLock->Acquire()
```

你的伪代码必须是精确的。例如，在描述你对通信器类的解决方案时，仅仅说以下这些是不够的：

   if anybody is waiting, then signal cv

你需要说明你是如何确定是否有人在等待的，例如，通过说：
   
   if（waitingReceivers>0 or waitingSenders>0），then signal cv

此外，另一件需要记住的重要事情是，设计文件需要包括正确性不变式和测试策略。测试策略包括对测试方法的明确计划，并可能包括对用于测试正确性不变量的测试用例的描述。重点放在测试策略上。如果你愿意，你可以逐项列出需要测试的东西。

### 设计文档不能包含哪些内容

请记住，你的TA对这个项目非常了解。不要在你的设计文件中重述这个问题。你的助教对你的解决方案更感兴趣，而不是想知道你是否理解了这个问题。

你的设计文件应该只包含很少的实际代码，如果有的话。包括所有复杂程序的伪代码，但不要包括Java代码。

伪代码的目的是为了避免编程语言中所有令人讨厌的方面，这些方面使代码更难写，更难读。伪代码的目的不是为了不精确地说明你是如何解决一个问题的。我们欢迎评论，但是ASSERT和DEBUG语句，例如，不属于伪代码。

记住，我们必须阅读你的设计文件。如果你认为我们不想看到它，那就不要把它放进去!

## 怎样编写一份高效的设计文档

[How to write an effective design document – Rina Artstain](https://rinaarts.com/how-to-write-an-effective-design-document/)

到现在，你已经想出了一个美丽、优雅、坚实的软件设计。但要向前推进，你必须让它得到批准。为了得到批准，你必须把它传达给其他人。因为，不幸的是，在你的脑海中有这样的想法并不足以让它按照你的设想建成。将你的设计有效地传递出去并不是一件简单的事情，许多软件工程师在这方面并不熟练。但是和大多数技能一样，你写设计文档的技能也是可以提高的，我希望这篇文章能在你的道路上帮助你。

当我们写设计文档时，我们应该牢记两个主要的问题： 目标和受众。

### 目标


在我看来，这就是一份好的设计文件的三个目标。

- 从相关的利益相关者（工程经理、技术领导、其他相关小组的工程师）那里获得对高层架构的认同。
- 提供一个实现的蓝图。
- 提供文件（用于历史参考、入职培训等）。

但最重要的是。如果合适的话，设计文件可以包括需求的摘要--但它不应该被理解为一个愿望清单。阅读设计文件的人应该清楚地了解你打算做什么。

### 受众

谁将会阅读设计文件。

- 需要批准/提供设计反馈的人。
- 需要做文件中所述工作的人。
- 作者（几个月后你就不会记得你为什么要做这些了）。

除了他们的角色之外，读者可能对设计有不同的背景。

- 内部读者，他们已经知道背景，他们的记忆只需要被刷新。
- 外部读者或新来者，他们没有或几乎没有背景，需要对这份文件的内容有一个高层次的概述。

当我们写设计文件时，我们需要记住目的和不同的读者，这样我们才能在正确的地方写出正确的东西和正确的细节。

现在我们知道了为什么要写设计文件以及为谁写，让我们来谈谈它应该包括什么。

### 背景介绍

在我们做任何事情之前，我们需要吸引读者非常有限和容易分心的注意力。他们刚刚收到某种形式的通知，让他们知道我们与他们分享了一份供审查的文件，他们想知道这到底是怎么一回事。如果我们不吸引他们的注意力，他们可能会转到收件箱中的下一封邮件或下一个通知。不要把这个宝贵的区域浪费在技术上，给他们一些有趣的东西。  
  
所以，在标题之后--设计文档首先应该包括理解所要解决的问题所需的相关背景和信息。我们要解决的是What，Why。  
  
这应该是对你想实现的目标的总结，而不是你想如何实现它。检查你的设计是否有效的一个好方法是检查它是否真正实现了这一部分中规定的目标。  
  
1. 使之简短  
   
一个或两个段落。  
  
2. 而且要切中要害  

想一想，如果你在电梯里遇到你的上上级经理，你会如何向他们解释这个问题。他们有一些背景和技术知识，但没有参与到项目的细节中。  
  
3. 清晰  

尽量避免不必要的缩略语和内部术语。在可能的情况下，链接到所用术语的解释。  
  
4. 子弹点 (Bullet points)

如果能帮助你澄清问题或目标，你可以使用要点，但你不一定要这样做。如果你有3个以上的要点，请检查自己--它们真的是不同的目标吗？如果是的话，也许你想用一个设计来实现太多的目标，这应该被分割成不同的功能或组件来单独设计？  也就是目标点最多3个。
  
5. 告诉我你想要什么  

如果你在弄清你的目标方面有困难，你可以问自己。你想提供什么价值？丰田的5个为什么  [Five whys - Wikipedia](https://en.wikipedia.org/wiki/Five_whys) 也可以帮助你确定你真正要实现的目标。  
  
6. 大纲  

如果文件有几个主要部分，你可以在这一点上提供一个hight level的大纲。不是每个标题和副标题都应该在这里，但主要部分的链接可以帮助读者跳到他们感兴趣的部分。记住，我们要保持简短。  

### 技术上的问题

现在你已经让他们着迷了--增加关于审批过程的官僚主义部分，比如。

- 文件状态： WIP/under review/approved/implemented/cancelled
- 作者/DRIs/所有者
- 最后更新日期
- 要求的review日期
- 审批人列表

让你的批准人的生活更轻松。

- 如果他们被叫来是为了一个特定的目的，即安全或法律审查，那么就用一个直接的链接给他们指出相关部分的方向。如果他们关心的只是你的用户信息的保留政策，他们就不应该阅读你的API。

- 不是每个人的权重都一样。清楚地标明哪些审批人是必须的，哪些是可选的。

- 设定一个审查的日期。人们都很忙，他们必须为自己的工作安排优先次序。如果你把事情留到最后，依赖人们的好意，他们可能不会去审查你的文件。要尊重他们，给他们足够的时间来完成审查，但随着最后期限的临近，也可以随意催促他们。如果他们不及时提供反馈，你可以升级或在没有他们的批准下前进。节目必须继续下去。

### 参考

你不可能在一份文件中包括一个特定项目的所有背景和历史。然而，为了理解设计文件中的背景和决策，其中一些内容可能是必要的。添加一个带有相关链接的部分来帮助你的读者。这可能包括

- 需求文件
- 相关的设计文件
- 市场或用户研究
- 会议记录
- 以及更多。

在决定什么是重要的时候，请酌情决定。

#### 词汇表

每个领域都有自己的术语、语言和缩略语。对于任何一个已经工作了一段时间的人来说，这些术语是透明的，但对于新人或来自其他群体的读者来说--它们可能使你的文件无法阅读或理解。因此，包括一个词汇表是非常重要的。另一方面，对于已经熟悉所有术语的读者来说，它可能是冗长和多余的，而且文件的这个区域是昂贵的不动产。

一个合适的解决方案是将词汇表作为附录添加在文件的底部，并从这里链接到它。大多数时候，你只是把词汇表从一个文件复制到另一个文件，所以这不是一个很大的努力。如果你碰巧有你的组织行为，并且实际上有一个活生生的、不断更新的词汇表，你可以链接到该词汇表，但有一个特定的词汇表，只包括文件中的术语，可能对读者来说更容易处理。记住，这不是为你准备的--所以做任何你认为对读者更方便的事情。

### 非目标或超出范围的话题

如果有类似或相关的问题你决定不在本设计中处理，请在此说明。当你有意不处理X或Y时，评论和问题，如 "你为什么不处理X或Y"，会让人分心和恼火。我们不要烦扰读者，也不要烦扰我们自己。

### high level的架构

下一节应该包括对解决方案的高度概述。这通常包括一个包含设计的主要组成部分的图表或流程图。你不必使用UML或精确的注释，反正没有人记得那些规则。它应该让读者大致了解你想实现什么，以及不同的部分是如何相互作用的，而不需要太多细节。

比如说

![[Pasted image 20221106110330.png]]

你可能认为你的图很清楚，但它不是自我解释的。在图的后面，你应该包括对不同组件的描述，以及它们如何相互作用。

对于（同样的）例子。

当触发器发生时，流程开始，结果被存储在数据库中。警报被生成，用户被通知。然后，用户可以提供可选的反馈，这些反馈也被存储在数据库中。过程的健康和质量被监测并保存在监测系统中。过程结果、监测和用户反馈相结合，并显示在内部仪表板上。

### 详细设计

详细的设计应该探索上面列出的组件的细节。

如果你发现自己添加的顶层标题在高层架构中没有被列为一个组件，你应该问自己这是否是另一个组件的一部分，在这种情况下，它应该被移到该组件之下，或者在高层架构中缺少一个组件。你应该始终确保读者理解细节在大局中的位置，否则他们会迷失方向。

本节中适合的细节。

- APIs
- 伪代码
- 类结构
- 数据库模式
- 特定的技术堆栈

等等。

### 决策和取舍

这一部分可能包括需要做出的决定--例如，选择一个技术栈而不是另一个，重新使用现有的组件或从头开始编写新的组件，一些API或数据模型的决定等等。

从每个备选方案的概述开始，但要保持重点。3-4段应该是足够的。如果太长了，就把讨论移到文件的最后，作为附录，只包括这一部分的要点。详细的讨论是为你准备的，这样你就可以证明你的思考过程，也是为挑剔的评审员准备的。大多数读者不需要知道。我通常会在这部分之前写上一个大大的 "在此停止阅读 "或者。"未出炉的想法，谨慎行事"。

在你完成了对不同选项的概述之后，在一个表格中总结出利弊和权衡。帮助你的读者，决定你更喜欢哪种方案，但要对改变你的想法持开放态度。如果你不希望得到反馈，你首先就不应该问。

方案一
这个方案的概述

方案二
本方案概述

方案三
本方案概述

总结

![[Pasted image 20221106110853.png]]

#### 决策疲劳

把所有的决定留待反馈和讨论是很容易的，但说实话--大多数问题都是很直接的。对于这些问题，请写下你选择你认为最好的理由，并在未出炉的想法附录中保留详细的讨论，包括优点和缺点，供任何有疑问或问题的人参考。

如果你保留了太多的东西，会发生两件事。

- 你将无法在你的设计上取得任何进展，直到你在每个小的决定上得到大家的认可。
- 人们对任何事情都有意见，所以你最终会浪费很多时间来讨论那些并不重要或者显然是正确的方法的事情。

因此，最好将你想得到反馈的决定的数量限制在几个关键的决定上：那些对设计有深刻影响的或者以后难以改变的决定（类型1）[Jeff Bezos on Type 1, Type 2 Decisions (businessinsider.com)](https://www.businessinsider.com/jeff-bezos-on-type-1-and-type-2-decisions-2016-4) 

### 其他东西

一旦涵盖了设计细节，还有其他需要解决的问题。其中有些是你的产品所特有的，有些是整个行业所共有的。这些应该包括在你的组织的设计文件模板中，这样你就不会忘记它们。

本节中包括的常见主题有。

- 测试策略
- 文档
- 监测和分析
- 性能和规模
- 法律和安全
- 产品生命周期问题：例如，当用户加入/离开时，当客户升级/降级时，会发生什么。
- 发布计划：功能门槛、A/B测试、迁移等。

等等

> 这篇文章的大部分内容改编自Dropbox和Google的设计审查过程，并有一些我自己的改动。感谢开发这些流程的人，我有幸向他们学习。还要感谢我的母亲，她在我10岁的时候让我写操作电话的规范作为练习，给了我写技术规范的第一次经验。

## Google的design doc的模板

1. Background / Introduction (为什么要做这件事)

2. Requirements vs non-functional requirements: 明确好需求和设计的目的.  
3. Proposed solution and alternatives, 先说方案, 然后表明自己做过research, 但别的alternative没有我的好. 最好画些架构图方便大家理解. Proposed solution需要非常详细, 可以包括数据库schema设计, RPC method, 需要修改到的地方等等. Alternative可以简单一点, 但需要点明优劣. 如果系统比较大, 可以拆成不同components, 每个components都有proposed vs alternative..  
4. Test / Monitoring / Metric: 怎么做测试, 监控系统, 哪些metric可以衡量项目的成功 (帮助你升职)...  
5. Work items: 估计每部分需要多少时间 (多少engineer week)

6. Questions / Meeting notes: 一般设计的时候, reviewer会有些问题可以在这里clarify或者comments, 或者design review的时候记录一下别人的问题.

7. Reference: 放些相关的doc, 比如需要碰到的系统之类的.
