他们说区块链就像洋葱。洋葱有层次。区块链也有层。以太坊和它的第2层之间的共生关系是相互的，意味着两者都从这种关系中受益。以太坊向其生态系统中的第2层提供其永远重要的安全性，这意味着这些第2层在以太坊第1层结算其交易。他们是如何做到这一点的？第2层依赖以太坊的 "安全 "是什么意思？为了理解这一点，我们首先需要深入了解区块链的三角困境。

##### 区块链的三角困境(不可能三角)

在我们理解为什么第2层解决方案对以太坊生态系统至关重要之前，有一个重要的概念需要理解，叫做 "区块链的三角困境"。区块链三角困境指的是普遍持有的概念，即去中心化、安全和可扩展性是区块链的三大支柱，而去中心化的网络在任何时候都只能提供这三个好处中的两个。普遍持有的观念是，公共区块链基础设施必须牺牲安全、去中心化或可扩展性。

![[Pasted image 20221007095813.png]]

去中心化是区块链技术的核心精神，并推动整个生态系统的项目。区块链去中心化指的是计算能力和共识在整个网络中的有意义的分配。应用去中心化的流程和技术，消除了各行业的中介角色，并以许多不同的方式表现出来。例如：通过将银行机构从金融工具中移除，去中心化金融（DeFi）平台，而不是中介机构，能够将利润和治理分配给用户和更广泛的社区。

在更基础的层面上，去中心化网络众筹共识，意味着没有一个实体可以控制或审查通过它进行交易的数据。然而，实现最佳的去中心化往往会降低网络的吞吐量。随着越来越多的矿工通过共识确保工作证明（PoW）网络，交易速度可能会下降--这被认为是广泛采用的一个障碍。

安全性反映了一个区块链协议对恶意行为者和网络攻击的防御。为了提高区块链网络的网络吞吐量，有动力减少区块链节点的分布，无论是在地理上、数量上，还是两者上。然而，这种向更大的中心化发展的支点降低了PoW网络的安全性。当在一个节点分布有限的开放网络上达成共识时，51%的攻击更有可能发生，因为黑客可以更容易地积累所需的Hash能力。通过压倒性的网络，黑客可以劫持网络并操纵交易以获取经济利益。举例来说。2020年8月，以太坊经典（ETC）区块链--它是以太坊（ETH）的一个分叉--遭受了三次51%的攻击，重组(reorg)了4000多个区块。这使得肇事者能够操纵数据并加倍花费其ETC货币，导致网络上数百万美元的价值损失。区块链的安全性是一个关键的网络方面，不能受到影响。  
  
关于区块链协议的可扩展性是指区块链支持高交易量和未来增长的能力。这意味着，随着用例和采用的加速，区块链的性能不会受到影响。据称，随着采用率的增加而表现不佳的区块链缺乏可扩展性。区块链的三角困境告诉我们，更大的可扩展性是可能的，但安全、去中心化或两者都会因此而受到影响。可扩展性是区块链网络与当前中心化支付平台合理竞争的唯一途径，后者的网络结算时间和可用性在这一点上远远优于前者。  

具体来看以太坊，该网络的重点是去中心化和安全，每秒的交易数量（可扩展性）是有限的。为了鼓励矿工优先处理交易，用户支付更高的费用。随着对区块空间的需求增长，以太坊越来越受欢迎，对增加的需求，交易费用已经上升到一些人无法参与区块链的程度。以太坊费用的增加是三角困难问题的副产品，因为我们可以看到，以太坊无法在不牺牲安全或去中心化的情况下进行廉价的扩展。

可扩展性的改善可以发生在第1层和第2层。第1层的扩展解决方案对区块链协议本身的基础层进行了改变，以提高可扩展性，而第2层的解决方案建立在现有的第1层之上，以减少第1层需要达成共识的工作量，因此使用更少的资源。

现在我们对这个问题有了更好的把握，让我们退一步，定义区块链的不同层。

##### Layer 1

第1层网络是基础区块链的另一个名称。以太坊（ETH）、比特币（BTC）、BNB智能链（BNB）、Solana（SOL）、Avalanche（AVAX）和Fantom（FTM）都是第1层协议（除此之外）。我们把它们称为第1层，因为这些是其生态系统中的主要网络。与第1层相比，我们有离线链和其他第2层解决方案，它们建立在主链之上。  
  
第一层网络最终负责交易的结算。对于大多数网络来说，这意味着通过非对称密钥对及其相应的加密货币或代币余额来核算用户的账户，或钱包。所有第1层网络都有一个原生代币，提供对网络资源的访问。你使用一个网络的原生代币来支付网络服务，如发送其加密货币，铸造代币，或调用智能合约。  
  
在比较第一层网络时，必须了解其共识机制以及它所提供的优点或缺点。所涉及的共识机制一般在交易成本、安全性、可扩展性和去中心化之间进行权衡。共识机制有很多创新，是一个不断发展的领域，对今天已知的一系列区块链有很大的贡献。  
  
然而，致力于可扩展性的改善并不仅仅发生在第2层。第1层的扩展解决方案增强了区块链协议本身的基础层，以提高可扩展性。目前正在开发--和实践--一些方法学，直接改善区块链网络的可扩展性。下面是它的工作原理。

- 第1层解决方案直接改变协议的规则，以提高交易能力和速度，同时容纳更多的用户和数据。

- 第1层的扩展解决方案可能需要，例如，增加每个区块中包含的数据量，或加快区块确认的速度，以提高整个网络的吞吐量。

- 足够简单吗？可惜不是

增加区块大小或加快区块确认的速度的问题是，这时需要的计算能力远远超过标准的家用电脑来运行一个节点，这反过来导致获得运行一个去中心化节点的能力更少，这导致更多的中心化节点被更大的行为者创建，这导致少数人能够对系统施加更多的控制，这降低了安全性。

还记得区块链的这三个理想属性吗？去中心化、安全和可扩展性？区块链三角困难问题指出，一个简单的区块链架构只能实现三个中的两个。想要一个安全和去中心化的区块链？你需要牺牲可扩展性。那么，你能做些什么来使第一层的升级？牢记这一点。

- 共识协议的改进

    - 有些共识机制比其他机制更有效。PoW是目前流行的区块链网络如比特币使用的共识协议。虽然PoW是安全的，但它可能很慢。这就是为什么许多较新的区块链网络偏爱股权证明（PoS）共识机制。PoS系统不需要矿工使用大量的计算能力来解决加密算法，而是根据参与者在网络中的抵押品来处理和验证新的交易数据块。

    - 我们在之前的一篇文章中讨论了The Merge，即以太坊从PoW共识机制转变为PoS共识机制的事件，你可以在这里阅读。[[什么是Stake-共识机制和the-merge的简介]]

- 分片(sharding)
    
	- 分片是一种适应于分布式数据库的机制，已经成为最受欢迎的第一层扩展解决方案之一，尽管它在区块链领域具有一定的实验性。分片需要将整个区块链网络的状态分解成不同的数据集，称为 "分片"--这是一项比要求所有节点维护整个网络更容易管理的任务。这些网络碎片同时被网络并行处理，允许对众多交易进行顺序工作。

    - 此外，每个网络节点被分配到一个特定的分片(shard)，而不是维护整个区块链的副本。各个分片向主链提供证明，并通过跨分片的通信协议相互作用，分享地址、余额和一般状态。以太坊是一个高知名度的区块链协议，它正在探索分片，还有Zilliqa、Tezos和Qtum。

以太坊已经达到了网络目前的容量，每天有100多万笔交易，而且每笔交易的需求量很大。以太坊的成功，其社区的力量，以及对使用它的需求，导致gas价格大幅上涨。因此，对以太坊第1层之外的额外扩展解决方案的需求也在增加。

这就是第2层网络的作用。

##### Layer 2

第2层是以太坊扩展区块链网络的统称，它通过处理以太坊第1层以外的交易来扩展以太坊（或另一个第1层）的功能，同时仍然利用以太坊第1层的去中心化的安全性。这可能是为了提高第一层网络的性能，减少交易费用，或增加可编程性。例如，在以太坊上，gas费用可能是高度可变的，交易时间也很慢，越来越多的应用程序开发人员为其用户提供与第二层网络互动的能力，以减少其用户的费用和交易延迟。  
  
第2层区块链定期与以太坊进行沟通（通过提交交易捆绑），以确保其具有类似的安全和去中心化保障。所有这些都不需要对第1层协议（以太坊）进行修改。这让第1层处理安全、数据可用性和去中心化，而第2层则处理扩展问题。第2层将交易负担从第1层移除，并将最终证明发布到第1层。通过从第1层移除这一交易负载，基础层变得不那么拥挤，一切都变得更加可扩展。此外，随着第1层实施新的协议，以帮助其扩展（如以太坊转向PoS共识机制（"the merge"），然后实施分片，这将使以太坊的容量成倍增加），第2层将受益，并在他们已经扩展了基础第1层的数量级的基础上，反过来增加速度/能力。  
  
##### Layer 3

第三层区块链协议，或区块链的去中心化应用（dApp）层，可以分成两个主要的子层--应用和执行，这取决于特定的dApp的使用情况。

应用子层涉及面向用户的应用程序，旨在促进用户与区块链的互动，其主要组件是API、用户界面（UI）和脚本。

另一方面，执行层处理：规则和智能合约。因此，它持有实际的应用果汁，也就是代码。这两层之间的交叉点出现在执行过程中。例如，当用户使用应用层在DEX上发起代币交换时，该交易就会进入执行层进行处理。


##### Layer 0

第0层协议可以在多个用例中使用，包括数据验证、设置个人奖励结构、数字货币包装等等。它作为一个根层，允许与所有第1层协议如BTC、ADA、Ethereum等进行跨链互操作。我们不会在这里集中讨论第0层，但了解基础知识是很好的。我们会在某个时候再来讨论这个问题!

现在我们明白了这些部分在概念上是什么，让我们更深入地了解它们的工作方式。

第2层区块链在原生层上运行，以提高其效率。有效地卸载交易，第2层把第1层区块链的一部分交易负担，交给另一个系统架构。然后，第2层区块链处理处理负荷，并向第1层报告结果的最终确定。由于大部分数据处理负荷交给了这个相邻的辅助架构，网络拥堵就会减少：不仅第1层区块链变得不那么拥堵，而且还变得更加可扩展。

那么，第2层的例子有哪些呢？

##### 状态通道

状态通道是用于允许用户在区块链之外的一层（链外）直接进行相互操作的机制。他们只在通道关闭时向区块链报告结果。使用状态通道的第二层协议的一个很好的例子是比特币的闪电网络。

闪电网络是一个在比特币区块链之上运行的第二层支付通道，其目的是在链外处理多个小型交易，以减少主链的拥挤，为大型交易腾出空间。[[区块链扩容之状态通道]]

##### Plasma

Plasma是以太坊区块链的一个扩展解决方案。与比特币的闪电网络不同，Plasma采取了一种不同的方法，因为它提供了一个通用的框架，支持创建由以太坊驱动的其他 "子链"。Plasma采用Merkle Trees加上智能合约来创建本质上是精简版的Ethereum。不幸的是，最初的Plasma模型从未被实施，而以太坊现在正专注于其他第二层解决方案，如Rollups。

在以太坊的情况下，运行在它上面的应用程序不断耗尽其网络容量，造成瓶颈。第二层解决方案的目的是疏通网络，以克服高额费用和缓慢的确认时间。[[区块链扩容技术之Plasma]]

##### Rollups(Optimistic 和 zk)

Rollups是一种扩展解决方案，通过卷积(rolling up)（因此而得名）交易的集合来工作。最后，卷起的交易作为一个单一的交易呈现在以太坊区块链上。把多个交易压缩成一个交易。

Rollups削减了成本：一个以太坊交易的成本，加上rolling up交易批量的小成本，在用户之间分摊。他们也加快了速度：the rollup的执行速度非常快，以太坊区块链只需要处理一个交易，而不是很多。当以太坊在没有辅助的情况下，每秒最多可处理约15笔交易时，这很有用。

有两种主要类型的rollups：Optimistic Rollups和zk-Rollups。

##### Optimistic Rollups

Optimistic Rollups与第2层的以太坊主链并行。他们可以提供可扩展性方面的改进，因为他们默认不做任何计算。相反，在交易之后，他们向主网提出新的状态，或对交易进行 "公证"。

有了Optimistic Rollups，交易被作为`calldata`写入以太坊主链，通过减少gas成本进一步优化它们。

由于计算是使用以太坊的缓慢而昂贵的部分，Optimistic Rollups可以提供高达10-100倍的可扩展性改进，这取决于交易的情况。随着我们之前提到的分片的引入，这个数字会增加得更多，因为如果交易有争议，会有更多的数据可用。[[区块链扩容之Optimistic Rollups]]

##### 对交易提出异议(Disputing transactions)

Optimistic Rollups不计算交易，所以需要有一个机制来确保交易是合法的而不是欺诈性的。这就是欺诈证明的作用。如果有人注意到一个欺诈性的交易，Optimistic Rollups将执行欺诈证明，并使用可用的状态数据运行交易的计算。这意味着你可能比ZK-rollup有更长的交易确认等待时间，因为交易可能被质疑。[[区块链扩容之Optimistic Rollups#^03d1ca]]

你运行欺诈证明的计算所需的gas甚至可以得到补偿。来自Optimism的Ben Jones介绍了现有的担保系统。

> 任何可能采取你必须证明欺诈行为的行动以确保你的资金安全的人，都需要你交纳保证金。你基本上拿一些ETH，把它锁起来，你说 "嘿，我保证说实话"......如果我不说实话，欺诈被证明，这笔钱就会被砍掉。这笔钱不仅会被砍掉一部分，而且有一部分会支付人们做欺诈证明所花费的gas。- 本-琼斯

所以你可以看到激励措施：参与者因进行欺诈而受到惩罚，因证明欺诈而得到补偿。

##### zkRollups

零知识的证明必须满足以下三个要求。  
  
- 不可反驳性。如果主张是真实的，诚实的verifier将被同样诚实的prover（即正确遵循协议的人）说服其完整性。  
  
- 健全性。如果声称是不真实的，那么不诚实的prover只有很小的机会可以说服诚实的verifier相信它是真实的。  
  
- 零知识性。如果声称是准确的，verifier唯一知道的是该声称是有效的。  
  
ZK-rollups将成百上千的转账捆绑在链外，并生成一个加密证明。这些证明可以以SNARKs（简洁的非交互式知识论证）或STARKs（可扩展的透明知识论证）的形式出现。允许zk-rollups比第1层区块链更快地成功验证交易的主要组件之一是Merkle Trees。  
  
Merkle Trees是一种重要的数学结构，它允许区块链确保没有人可以在zk-rollup的链上记录中伪造数据。通常，一个Zk-rollup由两个Merkle Trees组成，它们都存储在智能合约上，或者换句话说，在链上（因为zkRollup也需要在ETH主网上部署一套智能合约）。一个树专门用于存储账户，而另一个树则存储所有的余额。zk-rollup产生和使用的任何其他类型的数据都存储在链外。  
  
不像Optimistic Rollups交易迫使交易等待一段时间的欺诈证明，当ZK-SNARK被发送到以太坊时，接收的智能合约可以即时验证该证明是否在链上有效。

因为ZK-SNARKs被即时验证，所以当ZK-SNARK交易在以太坊上被挖出时，被打包进块时（约12秒），ZK-rollups上的资金就能被提取(withdraw)，而不是等待几天或几周的争议期结束。

有效性证明可以防止欺诈，而无需像欺诈证明那样进行人工干预或验证，这使得用ZK-rollups进行的交易确认比Optimistic rollups要快得多，而且可扩展。[[区块链扩容之zkRollups]]
