以太坊的共识:LMD-GHOST

几周前，以太坊已经正式切换成PoS共识了，大部分时候，共识都是顺序的，一般都可以达到一致，区块链也是一个区块一个区块的增长。

但是，有些时候，区块还是会产生分叉，所以分支选择就出现了，这就是为什么我们需要分支选择的规则。

![[Pasted image 20221004215835.png]]

以太坊的网络上大概运行了1000个左右的节点，每个节点本地都运行着一个EVM虚拟机，所有的EVM都保持同步，这些同步就是共识算法保证的。共识有PoW和PoS。

PoW和PoS都是指定一个 "leader "节点的系统，并允许他们将他们的EVM副本向前推进，区块链不停地增长（使用来自像你和我这样的用户提交的交易）。

一旦他们完成了尽可能多的交易，他们就会创建一个区块。

一个区块是在每个节点成为leader期间在EVM内发生的所有交易的完整记录。

任何其他节点都可以读取该区块，处理交易，并使其EVM的副本与leader相匹配。这里请回顾[[ETH之Casper FFG共识]]

每隔~12秒（称为一个slot），就会选择一个新的leader。leader选择txns(也就是被打包进区块的交易列表)，通过他们的本地EVM运行它们，建立一个块并将其发布到网络上。

当其他节点收到区块时，他们会在本地封闭地运行这个区块中的txns，从而同步他们的本地EVM状态。

![[Pasted image 20221004220705.png]]


推进EVM的状态是以交易开始时EVM的状态为前提的。

通过接受下一个交易，每个节点（也就是网络/世界计算机）都在确认它之前的每一个交易。

这里有一个简单的例子来说明这个原理。

除非交易#4先发生，否则交易#5是不可能的（Bob不会有他打算发送的11）。通过执行#5，我们确认#4必须已经发生（以及在它之前的那些）。

![[Pasted image 20221004220909.png]]

在正常情况下，区块链是1个区块接1个区块地增长的；每个leader有序地提出一个新区块，被网络接受并添加到区块链中。

然而，网络可能会失去同步性，节点可能会出现一个以上的有效构建的区块。（相当于网络出现分区了？脑裂？这个待考证）

![[Pasted image 20221004221100.png]]

一个选择被称为分叉，而一个分叉可以增长。

如果网络失去了同步，它可能会失去一个以上的slot。随着问题的持续存在，分叉的分支会越来越宽，越来越深，呈现出越来越多的选择。

> 以上的话怎么理解？比如因为网络的不可靠，失去了同步性，在一个slot内，一般只有一个leader是不是？一个slot是一个固定时间区间，随着slot的切换，leader跟着切换，不同的leader之间发布的区块，因为网络失去了同步，就导致，别的leader没有收到上一个leader的区块，那么就会产生分叉，因为网络的不可靠，不同的leader节点看到的上一个区块是不同的，也就是view也不同，就导致分歧越来越多，导致一个树形的区块分叉，然后，区块链值可以选择这些分叉中的其中一个，这个就是分叉选择算法做的事情。

![[Pasted image 20221004221557.png]]

对于试图保持同步的系统来说，选择是一种存在的危险。如果一个节点操作员(operator)有自由裁量权，他可能会做出与另一个节点操作员不同的选择。

节点操作者得到的不是选择，而是一个分叉选择的算法。

 分叉选择算法（也称为分叉规则）是一个函数，它吸收所有可能的分支并输出一个单一的 "典型链"。(在N个分叉中只选择一个它认为的最好的链)

所有的节点操作者都共享分叉选择规则。因此，当面临选择时，所有节点都会统一行动。

贪婪最重的观察子树（GHOST, Greedy heaviest obverved subtree）是一个分叉选择的规则，它选择具有最大累积权重（确认次数）的分叉。[[Polkadot学习笔记#分叉选择]]

在这个例子中，GHOST会确认A块，即使B块的链更长。

![[Pasted image 20221004222058.png]]

以太坊已经实现了GHOST的修改版本，称为最新信息驱动的GHOST（LMD-GHOST）。这里与polkadot的差不多，大同小异 [[Polkadot学习笔记#最终Gadget Grandpa]]

这描述了如果从一个节点收到多个消息所做的决定。LMD-GHOST只会考虑最新的一条，而抛弃其他的。

 LMD-GHOST是保持以太坊保持同步的关键部分。如果没有分叉选择算法，正常的网络拥堵可能会将网络推入混乱的状态，加速越来越多的不同步和分叉。你的节点的链与我的链不一样，账户余额也不一样。

LMD-GHOST在一个节点感到困惑时提供了清晰的信息。