## H264的I帧，P帧，B帧

I帧可以独立解码，可以理解是一张完整的静态图像，[一组GOP]([(4条消息) 简析H264编码中的GOP_飞天神龟的博客-CSDN博客](https://blog.csdn.net/feitsg/article/details/105619729))中，只有一个I帧(IDR帧)，而且是第一个，IDR帧时一种特殊的I帧，一组GOP中可以有很多I帧，但是只有一个IDR帧。

P帧紧跟其后，P帧传输的是参考前面一帧(I帧或P帧)变化的图像部分，所以被压缩了，效率也提高了, 所以解码P帧时，必须将之前的I帧和P帧叠加在一起才可以解码完整的P帧图像。如果其中一个P帧有问题，那么后面的P帧就容易把错误放大，造成解码错误扩散。


对于B帧，如果是P帧时记录前一帧图像的变换和差别，那么B帧就是记录本帧和前后帧的差别。也就是说要解码B帧，不仅要缓存之前的帧画面，还有解码之后一帧的画面，通过前后画面与本帧数据的叠加取得最终的B帧画面。这样B帧的压缩率就更高，对解码性能要求也高，B帧比P帧更小，更节省空间。B帧是由前面的I或P帧和后面的P帧来进行预测的; 

由此可以看出，B帧不作为参考帧，只有I和P帧会作为参考帧。所以B帧的错误不会造成解码错误的扩散。

所以你可以看到，B帧和P帧的区别，压缩效率也有区别，所以这两种帧有一定相对的场景应用，因为B帧同时也参考后面的帧所以需要缓存当前B帧，拿到后面的帧再叠加解码，这样视频的实时性会受到干扰，也就是延迟加大，因为越实时，最好的方法就是拿到之前的数据就可以解码展示。所以在大部分实时视频场景中，比如音视频会议，都是使用I帧+P帧，没有使用B帧或者尽可能少使用B帧。而在大量的音视频转码时，会大量使用B帧，为了减少存储空间。


如果定义视频图像流的传输方向从左往右，那么就是:   ..P..PBPI 或者是 BP...PBI

![[Pasted image 20220727144624.png]]

以GOP1为例，可以看见第一个I帧指向三个B帧以及一个P帧，这是因为P帧向前参考解码，但是前面三个B帧无法参考，所以要参考I帧，拿到公共部分数据，进行解码。

B帧前后参考解码，所以既要参考I帧，也要参考后面的P帧，所以在传输时，虽然是按照IBBBP的顺序进行传输，但是实际解码顺序确是IPBBB，第一帧无疑解IDR帧，第二帧解码P帧，所以实时性不是太好。

B帧前后参考时，向前也可以参考P帧，图内可以看出来这一点。
B帧与B帧是没有任何参考的。

## H264码流中的SPS,PPS

#### SPS

在H264标准协议中，规定了多种不同的NAL Unit类型，其中类型7表示该NAL Unit内保存的数据是序列参数集合SPS(Sequence Parameter Set)。在H264中，SPS的信息**很重要**，如果其中的数据丢失或者出现错误，那么解码过程很可能会失败。SPS以及PPS(Picture Parameter Set)在某些平台的视频处理框架(如iOS下的VideoToolBox等)还通常作为解码器实例的初始化信息使用。

SPS中保存了一组编码视频序列(coded video sequence)的全局参数。所谓的coded video sequence就是原始视频的一帧一帧的像素数据经过编码后的结构组成的序列，而每一帧的编码后数据所依赖的参数保存于PPS中。一般情况下，SPS和PPS的NAL Unit同行位于整个码流的起始位置。但是在某些情况下，在码流中间也可能出现这两种结构，主要原因是:

- 解码器需要在码流中间开始解码
- 编码器在编码的过程中改变了码流的参数(比如图像分辨率等)

所以解码必须包含SPS，它很重要，无论是视频播放器还是流媒体播放器，都需要对SPS其中的数据进行解析。

SPS中的数据字段，详情需要看H.264的spec。[(4条消息) H264码流中SPS PPS详解_smartDMer的博客-CSDN博客_h264 sps](https://blog.csdn.net/smartgps2008/article/details/124130429)

#### PPS

除了SPS外，还有一个参数集合也很重要，叫图像参数集合PPS(Picture Parameter Set)，PPS与SPS很相似，都是在H264的码流中单独保存在一个NAL Unit中，nal_unit_type的值是8，而在容器封装格式中(mp4,mkv等格式)，PPS与SPS通常在一起，保存在视频文件的文件头中。


在进行RTP传输H264的时候，需要用到sdp协议，有个sdp文件和格式规范，PPS和SPS都在sdp文件格式中以Base64的编码方式存在。

## H264的整体格式解析

H264是MPEG-4标准定义的一种编码格式，比较新。H264是经过有损压缩编码的，但是在技术上尽可能做的降低存储体积下兼顾较好的图像质量和低带宽图像快速传输。

所以本质上，H264是一种视频压缩算法。在空间，时间，局部关联性，结构纹理相似性，视觉弱感知上都尽可能进行压缩。

从功能上描述，H264分为两层，VCL(视频编码层)和NAL(网络提取层)

- VCL, 包括核心压缩引擎和块，宏块和片的语法级别定义，设计目标是尽可能地独立于网络进行高效编码，这里主要是H264的软件部分，也就是编解码算法部分。
- NAL， 负责将VCL产生的二进制串适配到各种各样的网络和多元环境中，覆盖了所有片级以上的语法级别。这里也就是我们所说的H264码流格式部分。

如果有一个H264分析器打开一个.h264的裸码流文件，你会看到是一段一段的NALU(NAL Unit)组成的，非常纯粹。只是最前面的两个NAL unit分别是SPS和PPS。

![[Pasted image 20220728094349.png]]

![[Pasted image 20220728094405.png]]

#### NAL Unit(NALU)的格式

![[Pasted image 20220728095537.png]]


