## 消息通知系统设计

通知是如何推送到我们的手机或电脑上的？

可以使用一个消息解决方案（Firebase）来支持通知的推送。下图显示了Firebase云信息服务（FCM）的工作方式。

![[Pasted image 20220711094508.png]]


FCM是一个跨平台的消息传递解决方案，能够可靠地编排、发送、排队和路由通知。它在消息发送者（应用服务器）和接收者（客户端应用）之间提供了一个统一的API。应用程序开发人员可以使用这个解决方案来推动用户保留。  
  
步骤1-2：当客户端应用程序首次启动时，客户端应用程序向FCM发送凭证，包括发送者ID、API密钥和应用程序ID。FCM为客户端应用程序实例生成注册令牌（所以注册令牌也被称为实例ID）。  
  
这个令牌必须包含在通知中。第3步：客户端应用程序将注册令牌发送至应用程序服务器。应用服务器为后续通信缓存该令牌。  
  
随着时间的推移，应用服务器有太多的令牌需要维护，所以推荐的做法是用时间戳存储令牌，并不时地删除陈旧的令牌。  
  
第四步：有两种方法来发送消息。一种是直接在控制台GUI中编写消息（步骤4.1，），另一种是从应用服务器中发送消息（步骤4.2。）我们可以使用Firebase Admin SDK或HTTP来发送后者。  
  
第5步：FCM接收消息，如果设备不在线，则在存储区排队等待消息。  
  
第6步：FCM将消息转发到平台级传输。这个传输层处理平台特定的配置。  
  
第7步：消息被路由到目标设备。通知可以根据应用服务器发送的配置来显示。  
  
